<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sá»• Tay & Quiz Tá»« Vá»±ng Tiáº¿ng Anh 10 Global Success</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Draggable.min.js"></script>

    <style>
        /* Font vÃ  mÃ u sáº¯c cÆ¡ báº£n */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Light background */
            color: #1f2937; /* Gray-800 */
        }
        /* Style cho nÃºt Unit Ä‘ang hoáº¡t Ä‘á»™ng */
        .unit-button.active {
            background-color: #10b981; /* Emerald-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4), 0 2px 4px -2px rgba(16, 185, 129, 0.4);
        }
        /* Style cho tab Ä‘ang hoáº¡t Ä‘á»™ng */
        .tab-button.active {
            border-bottom: 3px solid #10b981; /* Emerald-500 */
            color: #10b981;
            font-weight: 700;
        }
        /* Style cho sub-tab (Ã”n luyá»‡n) Ä‘ang hoáº¡t Ä‘á»™ng */
        .practice-sub-tab-button.active {
            background-color: #10b981; /* Emerald-500 */
            color: white;
        }
        .practice-sub-tab-button:not(.active) {
            background-color: #e5e7eb; /* Gray-200 */
            color: #1f2937;
        }

        /* Style cho Flashcard */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            height: 300px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: white;
        }
        .flashcard-back {
            transform: rotateY(180deg);
            background-color: #ecfdf5; /* Emerald-50 */
        }
        /* Style cho Quiz */
        .quiz-option {
            transition: background-color 0.3s, border-color 0.3s;
            cursor: pointer;
        }
        .quiz-option.correct {
            background-color: #d1fae5; /* Green-100 */
            border-color: #10b981; /* Emerald-500 */
            font-weight: 700;
        }
        .quiz-option.incorrect {
            background-color: #fee2e2; /* Red-100 */
            border-color: #ef4444; /* Red-500 */
        }
        
        /* Matching Word Styles (Ná»‘i Tá»«) */
        .card-item {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card-item:hover:not(.matched):not(.selected) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .selected {
            border: 3px solid #3b82f6 !important; /* Blue-500 */
            background-color: #eff6ff !important; /* Blue-50 */
            transform: scale(1.02);
        }
        .correct {
            border: 3px solid #10b981 !important; /* Emerald-500 */
            background-color: #ecfdf5 !important; /* Emerald-50 */
        }
        .incorrect {
            border: 3px solid #ef4444 !important; /* Red-500 */
            background-color: #fef2f2 !important; /* Red-50 */
        }
        .matched {
            cursor: default;
            pointer-events: none;
        }
        
        /* Audio Hunt Styles (NEW) */
        #audioHuntSpeaker {
            transition: 0.2s;
        }
        #audioHuntSpeaker:hover {
            transform: scale(1.1);
        }
        .word-card.bg-green-500, .word-card.bg-red-500 {
            border-color: transparent !important;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            color: white !important;
            pointer-events: none !important;
        }
        .word-card.bg-red-500 {
            background-color: #f44336 !important;
        }
        .word-card.bg-green-500 {
            background-color: #4CAF50 !important;
        }
        .word-card.disabled-round-end {
            pointer-events: none !important;
        }

        /* NEW: Word Puzzle Styles (Tetris/Falling Letters) */
        
        /* Game Grid Container */
        #gameArea-word-puzzle {
            /* These styles will be set by JS based on constants */
            /* But we define defaults here */
            display: grid;
            width: 90vw; /* Responsive size */
            max-width: 300px;
            height: 90vw;
            max-height: 300px;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
            border: 4px solid #1f2937;
            background-color: #f0f0f0; /* Light background for the grid */
        }

        /* Individual Grid Cells */
        .grid-cell {
            background-color: transparent;
            border: 1px solid #ccc; /* Subtle grid lines */
            box-sizing: border-box;
            display: flex; /* Allow content inside cell */
            align-items: center;
            justify-content: center;
        }

        /* Letter Block (Falling or Locked) */
        .letter-block {
            width: 100%;
            height: 100%;
            border-radius: 3px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            user-select: none;
            transition: opacity 0.1s;
        }

        .letter-block.locked {
            cursor: pointer; /* Clickable when locked */
            opacity: 1;
        }
        
        /* Dim used blocks in the grid */
        .letter-block[data-used="true"] {
            opacity: 0.4; 
            pointer-events: none;
        }

        /* Drop Zone Styles (For arranging the final word) */
        #dropZone-word-puzzle {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            min-height: 60px;
        }
        .dropSlot-word-puzzle {
            width: 40px; 
            height: 40px;
            margin: 0 5px;
            border: 2px dashed #333;
            border-radius: 5px;
            text-align: center;
            line-height: 36px; 
            font-size: 20px;
            font-weight: bold;
            background: #fff;
            color: #333;
            cursor: pointer; /* Cho phÃ©p click Ä‘á»ƒ xÃ³a */
        }
        
        #info-word-puzzle {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        #message-word-puzzle { 
            margin-top: 10px; 
            font-size: 18px; 
            font-weight: bold; 
        }

        /* Responsive adjustments for Drop Zone Slots */
        @media (min-width: 640px) {
            .dropSlot-word-puzzle {
                width: 50px;
                height: 50px;
                line-height: 46px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
                Sá»• Tay Tá»« Vá»±ng
            </h1>
            <p class="mt-2 text-xl text-emerald-600">
                Tiáº¿ng Anh 10 Global Success
            </div>
        </header>

        <div id="unit-selection" class="flex flex-wrap justify-center gap-2 p-4 bg-white rounded-xl shadow-lg mb-6">
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-1">UNIT 1</button>
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-2">UNIT 2</button>
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-3">UNIT 3</button>
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-4">UNIT 4</button>
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-5">UNIT 5</button>
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-6">UNIT 6</button>
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-7">UNIT 7</button>
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-8">UNIT 8</button>
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-9">UNIT 9</button>
            <button class="unit-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 hover:bg-emerald-400 hover:text-white text-sm" data-unit="unit-10">UNIT 10</button>
        </div>

        <div class="flex border-b border-gray-300 bg-white rounded-t-xl overflow-hidden shadow-lg">
            <button class="tab-button w-1/3 py-3 px-4 text-gray-600 transition duration-200" data-tab="flashcard">
                <i class="fas fa-bookmark mr-2"></i> Flashcard
            </button>
            <button class="tab-button w-1/3 py-3 px-4 text-gray-600 transition duration-200" data-tab="vocabulary-list">
                <i class="fas fa-list-alt mr-2"></i> Danh sÃ¡ch tá»« vá»±ng
            </button>
            <button class="tab-button w-1/3 py-3 px-4 text-gray-600 transition duration-200" data-tab="practice">
                <i class="fas fa-brain mr-2"></i> Ã”n luyá»‡n
            </button>
        </div>

        <div id="content-area" class="bg-white p-6 rounded-b-xl shadow-lg min-h-[400px]">

            <h2 id="unit-title" class="text-2xl font-bold text-gray-900 mb-6 text-center border-b pb-3"></h2>
            
            <div id="flashcard-tab" class="tab-content hidden">
                <div id="flashcard-container" class="flashcard-container mb-6">
                    <div id="flashcard" class="flashcard">
                        <div class="flashcard-face bg-emerald-500 text-white flex-col justify-center">
                            <div id="word-to-speak" class="flex items-center justify-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-emerald-600 transition" onclick="speakWord(document.getElementById('card-word').textContent)">
                                <span id="card-word" class="text-4xl font-extrabold">Tá»« Vá»±ng</span>
                                <i class="fas fa-volume-up text-3xl"></i>
                            </div>
                            <span id="card-pos" class="text-xl mt-2 italic opacity-80"></span>
                            <p class="text-lg mt-1 font-mono italic">/ <span id="card-ipa-front">IPA</span> /</p> 
                        </div>
                        <div class="flashcard-face flashcard-back flex-col justify-start">
                            <p class="text-xl font-bold text-gray-900 mb-2">Äá»‹nh NghÄ©a:</p>
                            <span id="card-definition" class="text-2xl font-semibold text-emerald-700 mb-4"></span>
                            <p class="text-lg text-gray-700">/ <span id="card-ipa" class="font-mono italic"></span> /</p>
                            <p class="mt-4 text-md text-gray-600 border-t pt-2">VÃ­ dá»¥: <span id="card-example" class="italic"></span></p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center space-x-4 mt-6">
                    <button id="prev-card-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-150">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button id="flip-card-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-150">
                        Láº­t Tháº»
                    </button>
                    <button id="next-card-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-150">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                <p id="card-counter" class="text-center mt-4 text-gray-500 text-sm"></p>
            </div>

            <div id="vocabulary-list-tab" class="tab-content hidden">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Báº£ng Tá»« Vá»±ng Chi Tiáº¿t</h3>
                    <div id="vocab-table-container" class="overflow-x-auto">
                        <p class="text-gray-500">Äang táº£i danh sÃ¡ch tá»« vá»±ng...</p>
                    </div>
                </div>
            </div>

            <div id="practice-tab" class="tab-content hidden">
                <div class="mb-6 border-b pb-3 flex space-x-2 flex-wrap">
                    <button class="practice-sub-tab-button active bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200" data-practice-tab="quiz">
                        <i class="fas fa-question-circle mr-1"></i> Tráº¯c Nghiá»‡m
                    </button>
                    <button class="practice-sub-tab-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-200" data-practice-tab="match-game">
                        <i class="fas fa-link mr-1"></i> Ná»‘i Tá»«
                    </button>
                    <button class="practice-sub-tab-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-200" data-practice-tab="audio-hunt">
                        <i class="fas fa-volume-up mr-1"></i> Nghe & Chá»n
                    </button>
                    <button class="practice-sub-tab-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-200" data-practice-tab="fill-in-blanks">
                        <i class="fas fa-edit mr-1"></i> Äiá»n Tá»«
                    </button>
                    <button class="practice-sub-tab-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-200" data-practice-tab="word-puzzle-tetris">
                        <i class="fas fa-cubes mr-1"></i> Xáº¿p Chá»¯
                    </button>
                </div>

                <div id="practice-quiz-content" class="practice-sub-content">
                    <div id="quiz-content">
                        <p id="quiz-question" class="text-xl font-semibold mb-6 p-4 border-l-4 border-blue-500 bg-blue-50 rounded-lg"></p>
                        <div id="quiz-options" class="space-y-3">
                            </div>
                        <button id="quiz-next-btn" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 hidden">
                            CÃ¢u Tiáº¿p Theo <i class="fas fa-chevron-right ml-2"></i>
                        </button>
                        <p id="quiz-message" class="mt-4 text-lg font-bold text-center"></p>
                    </div>
                </div>

                <div id="practice-word-puzzle-content" class="practice-sub-content hidden">
                    <div class="w-full text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">BÃ i Táº­p Ná»‘i Tá»« Vá»±ng Anh - Viá»‡t</h1>
                        <p id="instruction" class="text-gray-600">Chá»n má»™t tá»« tiáº¿ng Anh, sau Ä‘Ã³ chá»n nghÄ©a tiáº¿ng Viá»‡t tÆ°Æ¡ng á»©ng. (Tá»‘i Ä‘a 8 tá»«/lÆ°á»£t chÆ¡i)</p>
                        
                        <div id="match-message-box" class="mt-4 p-3 rounded-lg text-sm font-medium hidden"></div>
                    </div>

                    <div id="game-grid" class="w-full grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <div id="english-col-match" class="space-y-3 p-4 bg-white rounded-xl shadow-lg border border-gray-200">
                            <h2 class="text-xl font-semibold text-blue-700 mb-4 border-b pb-2">Tá»« Tiáº¿ng Anh</h2>
                            </div>

                        <div id="vietnamese-col-match" class="space-y-3 p-4 bg-white rounded-xl shadow-lg border border-gray-200">
                            <h2 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2">NghÄ©a Tiáº¿ng Viá»‡t</h2>
                            </div>
                    </div>

                    <div class="w-full mt-8 flex justify-center space-x-4">
                        <button id="check-btn-match" onclick="checkMatchAnswers()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50">
                            <i class="fas fa-check-circle mr-2"></i>Kiá»ƒm Tra Káº¿t Quáº£
                        </button>
                        <button id="reset-btn-match" onclick="initMatchGame()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-8 rounded-xl transition-all duration-200 shadow-md">
                            <i class="fas fa-redo mr-2"></i>ChÆ¡i Láº¡i
                        </button>
                    </div>
                </div>

                <div id="practice-audio-hunt-content" class="practice-sub-content hidden text-center p-4 bg-white rounded-xl shadow-lg">
                    
                    <h1 class="text-3xl font-extrabold text-blue-700 mb-6">Nghe vÃ  chá»n tá»« Ä‘Ã£ nghe</h1>

                    <div id="audio-hunt-topbar" class="flex justify-between mx-auto max-w-lg mb-6 text-lg font-semibold border-b pb-2 px-4">
                        <div>Äiá»ƒm: <span id="audioHuntScore">0</span></div>
                        <div>VÃ²ng: <span id="audioHuntRound">1</span>/10</div>
                        <div>â± <span id="audioHuntTimer">3</span>s</div>
                    </div>

                    <div id="audioHuntSpeaker" class="w-20 h-20 mx-auto bg-orange-500 rounded-full flex justify-center items-center cursor-pointer text-4xl text-white shadow-xl hover:scale-110 transition-transform mb-4">
                        <i class="fas fa-volume-up"></i>
                    </div>
                    <p class="text-gray-600 mb-4">Nháº¥n Ä‘á»ƒ nghe láº¡i</p>

                    <p id="audioHuntMessage" class="text-lg font-bold h-7 mb-4 text-center"></p>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 max-w-2xl mx-auto" id="audioHuntWordGrid"></div>

                    <div id="audioHuntGameover" class="hidden text-center text-xl mt-8 p-6 bg-emerald-50 rounded-xl border border-emerald-300">
                        <p class="text-3xl font-bold text-emerald-700 mb-4">ğŸ‰ HoÃ n thÃ nh!</p>
                        <p class="text-lg">Äiá»ƒm cá»§a báº¡n: <span id="audioHuntFinalScore" class="font-extrabold text-blue-600 text-2xl"></span></p>
                        <button id="audioHuntRestartBtn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150">
                            ChÆ¡i láº¡i <i class="fas fa-redo ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <div id="practice-fill-in-blanks-content" class="practice-sub-content hidden p-4">
                    <h1 class="text-3xl font-extrabold text-purple-700 mb-6 text-center">ğŸ“ BÃ€I Táº¬P ÄIá»€N Tá»ª</h1>
                    <div id="blank-question-box" class="p-6 bg-purple-50 rounded-xl border border-purple-200 mb-6">
                        <div id="blank-sentence" class="text-center">
                            <p class="text-xl font-medium text-gray-800 mb-4">Äang táº£i cÃ¢u há»i...</p>
                        </div>
                        <div class="flex items-center space-x-3 mt-4">
                            <input type="text" id="blank-input" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-purple-500 text-lg" placeholder="Nháº­p tá»« cáº§n Ä‘iá»n (khÃ´ng dáº¥u)">
                            <button id="blank-check-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150">
                                Kiá»ƒm Tra
                            </button>
                        </div>
                    </div>
                    <p id="blank-message" class="text-center text-lg font-bold h-8 mb-4"></p>
                    <button id="blank-next-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 hidden">
                        CÃ¢u Tiáº¿p Theo <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                    <div id="blank-stats" class="text-center mt-6 text-gray-600">
                        <span id="blank-score" class="font-bold text-xl text-green-700">0</span> Ä‘iá»ƒm | <span id="blank-progress">1/10</span>
                    </div>
                </div>
                
                <div id="practice-word-puzzle-tetris-content" class="practice-sub-content hidden p-4 text-center">
                    <h1 class="text-3xl font-extrabold text-teal-700 mb-2">ğŸ§© Xáº¾P CHá»® (FALLING LETTERS)</h1>
                    <p class="text-gray-600 mb-4">Vuá»‘t ngang Ä‘á»ƒ di chuyá»ƒn, vuá»‘t xuá»‘ng Ä‘á»ƒ tháº£ nhanh. Cháº¡m vÃ o **chá»¯ cÃ¡i mÃ u sÃ¡ng** Ä‘Ã£ dá»«ng Ä‘á»ƒ xáº¿p tá»«.</p>
                    
                    <div id="gameArea-word-puzzle" class="shadow-xl mx-auto bg-gray-200">
                        </div>
                    
                    <div id="dropZone-word-puzzle"></div>
                    <div id="info-word-puzzle" class="text-gray-700"></div>
                    
                    <div class="flex justify-center space-x-4 mt-6">
                        <button id="checkBtn-word-puzzle" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50">
                            <i class="fas fa-check-circle mr-2"></i>Kiá»ƒm tra tá»«
                        </button>
                        <button id="resetBtn-word-puzzle" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-8 rounded-xl transition-all duration-200 shadow-md hidden">
                            <i class="fas fa-redo mr-2"></i>Reset tá»« ghÃ©p
                        </button>
                    </div>
                    <div id="message-word-puzzle" class="text-center font-semibold h-6 mt-4"></div>

                    <audio id="dropSound" src="https://actions.google.com/sounds/v1/foley/wood_fall.ogg"></audio>
                    <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
                </div>
                </div>
        </div>
        
    </div>

    <script>
        // Start: Setup
        let currentUnit = 'unit-1';
        let currentCardIndex = 0;
        let currentQuizWord = null;
        let quizOptions = [];
        let score = 0;

        // NEW: TTS FUNCTION (Google TTS style using Web Speech API)
        function speakWord(word) {
            if ('speechSynthesis' in window) {
                // Há»§y bá» phÃ¡t Ã¢m trÆ°á»›c Ä‘Ã³ náº¿u cÃ³
                window.speechSynthesis.cancel(); 
                
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US'; // Äáº·t ngÃ´n ngá»¯ lÃ  Tiáº¿ng Anh
                utterance.pitch = 1;      // Äá»™ cao
                utterance.rate = 1;       // Tá»‘c Ä‘á»™
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('Web Speech API (Text-to-Speech) is not supported in this browser.');
                alert('TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ phÃ¡t Ã¢m tá»« vá»±ng (TTS).');
            }
        }
        // END TTS FUNCTION


        // NEW VOCABULARY DATA (Dá»® LIá»†U Tá»ª Vá»°NG KHÃ”NG Äá»”I)
        // ====================================================================================================
        // Data: Vocabulary for each unit (word, pos, ipa, definition, example)
        const vocabularyData = {
            // UNIT 1 - FAMILY LIFE
            'unit-1': [
                { word: 'Benefit', pos: 'n', ipa: '/ËˆbenÉªfÉªt/', definition: 'Lá»£i Ã­ch', example: 'Regular exercise has many health benefits.' },
                { word: 'Bond', pos: 'n', ipa: '/bÉ’nd/', definition: 'Sá»± gáº¯n bÃ³', example: 'A strong family bond is important.' },
                { word: 'Breadwinner', pos: 'n', ipa: '/ËˆbredwÉªnÉ™(r)/', definition: 'NgÆ°á»i trá»¥ cá»™t Ä‘i lÃ m nuÃ´i gia Ä‘Ã¬nh', example: 'My father is the breadwinner in our family.' },
                { word: 'Character', pos: 'n', ipa: '/ËˆkÃ¦rÉ™ktÉ™(r)/', definition: 'TÃ­nh cÃ¡ch', example: 'She has a strong character.' },
                { word: 'Cheer up', pos: 'v', ipa: '/tÊƒÉªÉ™r ÊŒp/', definition: 'Cá»• vÅ©, lÃ m vui lÃªn', example: 'I tried to cheer up my little sister.' },
                { word: 'Damage', pos: 'v', ipa: '/ËˆdÃ¦mÉªdÊ’/', definition: 'LÃ m há»ng', example: 'The fire damaged the old house.' },
                { word: 'Gratitude', pos: 'n', ipa: '/ËˆÉ¡rÃ¦tÉªtjuËd/', definition: 'LÃ²ng biáº¿t Æ¡n', example: 'I showed my gratitude with a thank-you note.' },
                { word: 'Grocery', pos: 'n', ipa: '/ËˆÉ¡rÉ™ÊŠsÉ™ri/', definition: 'Thá»±c pháº©m, táº¡p hoÃ¡', example: 'We need to buy groceries for the week.' },
                { word: 'Heavy lifting', pos: 'n', ipa: '/ËŒhevi ËˆlÉªftÉªÅ‹/', definition: 'Mang vÃ¡c náº·ng', example: 'My brother helps me with the heavy lifting.' },
                { word: 'Homemaker', pos: 'n', ipa: '/ËˆhÉ™ÊŠmmeÉªkÉ™(r)/', definition: 'NgÆ°á»i ná»™i trá»£', example: 'She decided to be a full-time homemaker.' },
                { word: 'Laundry', pos: 'n', ipa: '/ËˆlÉ”Ëndri/', definition: 'Quáº§n Ã¡o, Ä‘á»“ giáº·t', example: 'I do the laundry every Saturday.' },
                { word: 'Manner', pos: 'n', ipa: '/ËˆmÃ¦nÉ™(r)/', definition: 'CÃ¡ch cÆ° xá»­', example: 'Good manners are important in society.' },
                { word: 'Responsibility', pos: 'n', ipa: '/rÉªËŒspÉ’nsÉ™ËˆbÉªlÉ™ti/', definition: 'TrÃ¡ch nhiá»‡m', example: 'Taking care of the dog is my responsibility.' },
                { word: 'Routine', pos: 'n', ipa: '/ruËËˆtiËn/', definition: 'ThÃ³i quen háº±ng ngÃ y', example: 'I follow a strict daily routine.' },
                { word: 'Rubbish', pos: 'n', ipa: '/ËˆrÊŒbÉªÊƒ/', definition: 'RÃ¡c', example: 'Please take out the rubbish.' },
                { word: 'Spotlessly', pos: 'adv', ipa: '/ËˆspÉ’tlÉ™sli/', definition: 'Sáº¡ch khÃ´ng tÃ¬ váº¿t', example: 'The kitchen was spotlessly clean.' },
                { word: 'Strengthen', pos: 'v', ipa: '/ËˆstreÅ‹Î¸n/', definition: 'Cá»§ng cá»‘', example: 'Regular practice will strengthen your skills.' },
                { word: 'Support', pos: 'n,v', ipa: '/sÉ™ËˆpÉ”Ët/', definition: 'Sá»± á»§ng há»™, á»§ng há»™', example: 'The family offers great emotional support.' },
                { word: 'Washing-up', pos: 'n', ipa: '/ËŒwÉ’ÊƒÉªÅ‹ ËˆÊŒp/', definition: 'Viá»‡c rá»­a bÃ¡t', example: 'My sister always helps with the washing-up.' }
            ],
            // UNIT 2 - CLOTHING
            'unit-2': [
                { word: 'Casual', pos: 'adj', ipa: '/ËˆkÃ¦Ê’uÉ™l/', definition: 'ThÃ´ng thÆ°á»ng, bÃ¬nh thÆ°á»ng', example: 'She prefers casual clothes on the weekends.' },
                { word: 'Complicated', pos: 'adj', ipa: '/ËˆkÉ’mplÉªkeÉªtÉªd/', definition: 'Phá»©c táº¡p', example: 'The process of making this silk is complicated.' },
                { word: 'Design', pos: 'v', ipa: '/dÉªËˆzaÉªn/', definition: 'Thiáº¿t káº¿', example: 'He designed a new type of modern dress.' },
                { word: 'Fashionable', pos: 'adj', ipa: '/ËˆfÃ¦ÊƒnÉ™bl/', definition: 'Há»£p thá»i trang', example: 'She always wears fashionable clothes.' },
                { word: 'Fit', pos: 'v', ipa: '/fÉªt/', definition: 'Vá»«a váº·n', example: 'These shoes fit me perfectly.' },
                { word: 'Folk', pos: 'adj', ipa: '/fÉ™ÊŠk/', definition: 'DÃ¢n tá»™c, dÃ¢n gian', example: 'She bought a folk costume from the market.' },
                { word: 'Material', pos: 'n', ipa: '/mÉ™ËˆtÉªÉ™riÉ™l/', definition: 'Cháº¥t liá»‡u, váº­t liá»‡u', example: 'Cotton is a soft material.' },
                { word: 'Modesty', pos: 'n', ipa: '/ËˆmÉ’dÉ™sti/', definition: 'Sá»± khiÃªm tá»‘n', example: 'She wore her traditional clothes with modesty.' },
                { word: 'Pattern', pos: 'n', ipa: '/ËˆpÃ¦tÉ™n/', definition: 'Hoáº¡ tiáº¿t, máº«u váº½', example: 'The shirt has a lovely flower pattern.' },
                { word: 'Practical', pos: 'adj', ipa: '/ËˆprÃ¦ktÉªkl/', definition: 'Thá»±c táº¿', example: 'A uniform is practical for students.' },
                { word: 'Style', pos: 'n', ipa: '/staÉªl/', definition: 'Kiá»ƒu dÃ¡ng, phong cÃ¡ch', example: 'I like her modern style of dressing.' },
                { word: 'Symbol', pos: 'n', ipa: '/ËˆsÉªmbl/', definition: 'Biá»ƒu tÆ°á»£ng', example: 'The dove is a symbol of peace.' },
                { word: 'Trend', pos: 'n', ipa: '/trend/', definition: 'Xu hÆ°á»›ng', example: 'Short skirts are the latest trend this summer.' },
                { word: 'Traditional', pos: 'adj', ipa: '/trÉ™ËˆdÉªÊƒÉ™nl/', definition: 'Truyá»n thá»‘ng', example: 'The Ao Dai is the Vietnamese traditional dress.' },
                { word: 'Unique', pos: 'adj', ipa: '/juËËˆniËk/', definition: 'Äá»™c Ä‘Ã¡o', example: 'Each culture has its own unique clothing.' }
            ],
            // UNIT 3 - MUSIC
            'unit-3': [
                { word: 'Bamboo clapper', pos: 'n', ipa: '/ËŒbÃ¦mbuË ËˆklÃ¦pÉ™(r)/', definition: 'PhÃ¡ch tre', example: 'The traditional band uses a bamboo clapper for rhythm.' },
                { word: 'Comment', pos: 'n', ipa: '/ËˆkÉ’ment/', definition: 'BÃ¬nh luáº­n', example: 'The singer read all the comments on her video.' },
                { word: 'Competition', pos: 'n', ipa: '/ËŒkÉ’mpÉ™ËˆtÉªÊƒn/', definition: 'Cuá»™c thi', example: 'She won the singing competition.' },
                { word: 'Concert', pos: 'n', ipa: '/ËˆkÉ’nsÉ™t/', definition: 'Buá»•i hoÃ  nháº¡c', example: 'We bought tickets for the rock concert.' },
                { word: 'Composer', pos: 'n', ipa: '/kÉ™mËˆpÉ™ÊŠzÉ™(r)/', definition: 'NhÃ  soáº¡n nháº¡c', example: 'Beethoven was a famous German composer.' },
                { word: 'Cultural', pos: 'adj', ipa: '/ËˆkÊŒltÊƒÉ™rÉ™l/', definition: 'Thuá»™c vá» vÄƒn hoÃ¡', example: 'The show highlights the cultural heritage of the area.' },
                { word: 'Dislike', pos: 'v', ipa: '/dÉªsËˆlaÉªk/', definition: 'KhÃ´ng thÃ­ch', example: 'Many people dislike very loud music.' },
                { word: 'Famous', pos: 'adj', 'ipa': '/ËˆfeÉªmÉ™s/', definition: 'Ná»•i tiáº¿ng', example: 'He is famous for his beautiful songs.' },
                { word: 'Genre', pos: 'n', ipa: '/ËˆÊ’É‘ËnrÉ™/', definition: 'Thá»ƒ loáº¡i', example: 'What is your favorite music genre?' },
                { word: 'Instrument', pos: 'n', ipa: '/ËˆÉªnstrÉ™mÉ™nt/', definition: 'Nháº¡c cá»¥', example: 'The guitar is a popular musical instrument.' },
                { word: 'Melody', pos: 'n', ipa: '/ËˆmelÉ™di/', definition: 'Giai Ä‘iá»‡u', example: 'The song has a simple, beautiful melody.' },
                { word: 'Performance', pos: 'n', ipa: '/pÉ™ËˆfÉ”ËmÉ™ns/', definition: 'Buá»•i biá»ƒu diá»…n', example: 'The band gave a great performance last night.' },
                { word: 'Popular', pos: 'adj', ipa: '/ËˆpÉ’pjÉ™lÉ™(r)/', definition: 'Phá»• biáº¿n', example: 'Pop music is very popular among teenagers.' },
                { word: 'Record', pos: 'v', ipa: '/rÉªËˆkÉ”Ëd/', definition: 'Thu Ã¢m', example: 'She is recording her new album.' },
                { word: 'Rhythm', pos: 'n', ipa: '/ËˆrÉªÃ°É™m/', definition: 'Nhá»‹p Ä‘iá»‡u', example: 'The drummer keeps a steady rhythm.' },
                { word: 'Talent', pos: 'n', ipa: '/ËˆtÃ¦lÉ™nt/', definition: 'TÃ i nÄƒng', example: 'She has a natural talent for singing.' },
                { word: 'Unique', pos: 'adj', ipa: '/juËËˆniËk/', definition: 'Äá»™c Ä‘Ã¡o', example: 'Vietnamese folk music has a unique sound.' }
            ],
            // UNIT 4 - SPECIAL FOODS
            'unit-4': [
                { word: 'Attractive', pos: 'adj', ipa: '/É™ËˆtrÃ¦ktÉªv/', definition: 'Háº¥p dáº«n', example: 'The colourful dish was very attractive.' },
                { word: 'Boil', pos: 'v', ipa: '/bÉ”Éªl/', definition: 'Luá»™c', example: 'Boil the eggs for ten minutes.' },
                { word: 'Delicious', pos: 'adj', ipa: '/dÉªËˆlÉªÊƒÉ™s/', definition: 'Ngon, thÆ¡m ngon', example: 'The soup smells delicious.' },
                { word: 'Dish', pos: 'n', ipa: '/dÉªÊƒ/', definition: 'MÃ³n Äƒn', example: 'Pho is a traditional Vietnamese dish.' },
                { word: 'Fry', pos: 'v', ipa: '/fraÉª/', definition: 'ChiÃªn, rÃ¡n', example: 'Fry the onions until they are golden brown.' },
                { word: 'Grill', pos: 'v', ipa: '/É¡rÉªl/', definition: 'NÆ°á»›ng', example: 'We are going to grill some fish for dinner.' },
                { word: 'Healthy', pos: 'adj', ipa: '/ËˆhelÎ¸i/', definition: 'LÃ nh máº¡nh', example: 'Eating vegetables is very healthy.' },
                { word: 'Ingredient', pos: 'n', ipa: '/ÉªnËˆÉ¡riËdiÉ™nt/', definition: 'ThÃ nh pháº§n', example: 'Garlic is a key ingredient in this recipe.' },
                { word: 'Nutritious', pos: 'adj', ipa: '/njuËËˆtrÉªÊƒÉ™s/', definition: 'Bá»• dÆ°á»¡ng', example: 'Brown rice is more nutritious than white rice.' },
                { word: 'Popular', pos: 'adj', ipa: '/ËˆpÉ’pjÉ™lÉ™(r)/', definition: 'Phá»• biáº¿n', example: 'Pizza is popular all over the world.' },
                { word: 'Recipe', pos: 'n', ipa: '/ËˆresÉ™pi/', definition: 'CÃ´ng thá»©c náº¥u Äƒn', example: 'She gave me the recipe for her famous cake.' },
                { word: 'Serve', pos: 'v', ipa: '/sÉœËv/', definition: 'Phá»¥c vá»¥, dá»n ra', example: 'Serve the meal while it is still hot.' },
                { word: 'Slice', pos: 'v', ipa: '/slaÉªs/', definition: 'Cáº¯t lÃ¡t', example: 'Slice the bread thinly.' },
                { word: 'Taste', pos: 'v, n', ipa: '/teÉªst/', definition: 'Náº¿m, vá»‹', example: 'The cake tastes sweet.' },
                { word: 'Traditional', pos: 'adj', ipa: '/trÉ™ËˆdÉªÊƒÉ™nl/', definition: 'Truyá»n thá»‘ng', example: 'We only serve traditional food at the festival.' }
            ],
            // UNIT 5 - OUR HERITAGE
            'unit-5': [
                { word: 'Ancient', pos: 'adj', ipa: '/ËˆeÉªnÊƒÉ™nt/', definition: 'Cá»• xÆ°a', example: 'We visited an ancient temple.' },
                { word: 'Artifact', pos: 'n', ipa: '/ËˆÉ‘ËtÉªfÃ¦kt/', definition: 'Hiá»‡n váº­t', example: 'Many valuable artifacts were found at the site.' },
                { word: 'Citadel', pos: 'n', ipa: '/ËˆsÉªtÉ™del/', definition: 'ThÃ nh trÃ¬', example: 'The imperial citadel is a must-see.' },
                { word: 'Complex', pos: 'n', ipa: '/ËˆkÉ’mpleks/', definition: 'Quáº§n thá»ƒ', example: 'They are building a new sports complex.' },
                { word: 'Dynasty', pos: 'n', ipa: '/ËˆdÉªnÉ™sti/', definition: 'Triá»u Ä‘áº¡i', example: 'The Nguyen Dynasty was the last dynasty of Vietnam.' },
                { word: 'Emperor', pos: 'n', ipa: '/ËˆempÉ™rÉ™(r)/', definition: 'HoÃ ng Ä‘áº¿', example: 'The tomb was built for an ancient emperor.' },
                { word: 'Excavate', pos: 'v', ipa: '/ËˆekskÉ™veÉªt/', definition: 'Khai quáº­t', example: 'Archaeologists will excavate the site next month.' },
                { word: 'Feature', pos: 'n', ipa: '/ËˆfiËtÊƒÉ™(r)/', definition: 'NÃ©t Ä‘áº·c trÆ°ng', example: 'A unique feature of the temple is its stone carving.' },
                { word: 'Historic', pos: 'adj', ipa: '/hÉªËˆstÉ’rÉªk/', definition: 'CÃ³ tÃ­nh lá»‹ch sá»­', example: 'The battle took place at a historic location.' },
                { word: 'Heritage', pos: 'n', ipa: '/ËˆherÉªtÉªdÊ’/', definition: 'Di sáº£n', example: 'Ha Long Bay is a world natural heritage site.' },
                { word: 'Imperial', pos: 'adj', ipa: '/ÉªmËˆpÉªÉ™riÉ™l/', definition: 'Thuá»™c vá» hoÃ ng Ä‘áº¿/triá»u Ä‘Ã¬nh', example: 'The imperial palace is well preserved.' },
                { word: 'Monument', pos: 'n', ipa: '/ËˆmÉ’njumÉ™nt/', definition: 'ÄÃ i tÆ°á»Ÿng niá»‡m', example: 'There is a monument to the war heroes in the park.' },
                { word: 'Preserve', pos: 'v', ipa: '/prÉªËˆzÉœËv/', definition: 'Báº£o tá»“n', example: 'We must work to preserve our cultural heritage.' },
                { word: 'Relic', pos: 'n', ipa: '/ËˆrelÉªk/', definition: 'Di tÃ­ch, thÃ¡nh tÃ­ch', example: 'The museum has many religious relics.' },
                { word: 'Ruin', pos: 'n', ipa: '/ËˆruËÉªn/', definition: 'TÃ n tÃ­ch', example: 'We explored the ruins of the old castle.' }
            ],
            // UNIT 6 - GENDER EQUALITY
            'unit-6': [
                { word: 'Access', pos: 'n', ipa: '/ËˆÃ¦kses/', definition: 'Sá»± tiáº¿p cáº­n', example: 'Everyone should have equal access to education.' },
                { word: 'Discrimination', pos: 'n', ipa: '/dÉªËŒskrÉªmÉªËˆneÉªÊƒn/', definition: 'Sá»± phÃ¢n biá»‡t Ä‘á»‘i xá»­', example: 'Gender discrimination is illegal in most countries.' },
                { word: 'Eliminate', pos: 'v', ipa: '/ÉªËˆlÉªmÉªneÉªt/', definition: 'Loáº¡i bá»', example: 'We need to eliminate all forms of prejudice.' },
                { word: 'Empowerment', pos: 'n', ipa: '/ÉªmËˆpaÊŠÉ™mÉ™nt/', definition: 'Sá»± trao quyá»n', example: 'Education leads to womenâ€™s empowerment.' },
                { word: 'Equal', pos: 'adj', ipa: '/ËˆiËkwÉ™l/', definition: 'BÃ¬nh Ä‘áº³ng', example: 'Men and women deserve equal rights.' },
                { word: 'Gender', pos: 'n', ipa: '/ËˆdÊ’endÉ™(r)/', definition: 'Giá»›i tÃ­nh', example: 'What gender is the new baby?' },
                { word: 'Income', pos: 'n', ipa: '/ËˆÉªnkÊŒm/', definition: 'Thu nháº­p', example: 'She earns a high income as a lawyer.' },
                { word: 'Opportunity', pos: 'n', ipa: '/ËŒÉ’pÉ™ËˆtjuËnÉ™ti/', definition: 'CÆ¡ há»™i', example: 'He was given the opportunity to study abroad.' },
                { word: 'Pay gap', pos: 'n', ipa: '/ËˆpeÉª É¡Ã¦p/', definition: 'Khoáº£ng cÃ¡ch vá» lÆ°Æ¡ng', example: 'The gender pay gap is a worldwide issue.' },
                { word: 'Patriarchy', pos: 'n', ipa: '/ËˆpeÉªtriÉ‘Ëki/', definition: 'Cháº¿ Ä‘á»™ phá»¥ há»‡, gia trÆ°á»Ÿng', example: 'We still live in a largely patriarchy society.' },
                { word: 'Right', pos: 'n', ipa: '/raÉªt/', definition: 'Quyá»n lá»£i', example: 'All citizens have the right to vote.' },
                { word: 'Sex', pos: 'n', ipa: '/seks/', definition: 'Giá»›i tÃ­nh sinh há»c', example: 'The form asks for the applicantâ€™s name and sex.' },
                { word: 'Stereotype', pos: 'n', ipa: '/ËˆsteriÉ™taÉªp/', definition: 'KhuÃ´n máº«u, Ä‘á»‹nh kiáº¿n', example: 'We should break the gender stereotype.' },
                { word: 'Violence', pos: 'n', ipa: '/ËˆvaÉªÉ™lÉ™ns/', definition: 'Báº¡o lá»±c', example: 'Domestic violence is a serious crime.' },
                { word: 'Workforce', pos: 'n', ipa: '/ËˆwÉœËkfÉ”Ës/', definition: 'Lá»±c lÆ°á»£ng lao Ä‘á»™ng', example: 'More women are joining the workforce.' }
            ],
            // UNIT 7 - ECONOMIC REFORMS IN VIET NAM
            'unit-7': [
                { word: 'Capital', pos: 'n', ipa: '/ËˆkÃ¦pÉªtl/', definition: 'Vá»‘n', example: 'The company needs more capital to expand.' },
                { word: 'Development', pos: 'n', ipa: '/dÉªËˆvelÉ™pmÉ™nt/', definition: 'Sá»± phÃ¡t triá»ƒn', example: 'Economic development is a priority.' },
                { word: 'Economic', pos: 'adj', ipa: '/ËŒiËkÉ™ËˆnÉ’mÉªk/', definition: 'Thuá»™c vá» kinh táº¿', example: 'The country faced a severe economic crisis.' },
                { word: 'Enterprises', pos: 'n', ipa: '/ËˆentÉ™praÉªzÉªz/', definition: 'Doanh nghiá»‡p', example: 'Small and medium enterprises are important.' },
                { word: 'Export', pos: 'v', ipa: '/ÉªkËˆspÉ”Ët/', definition: 'Xuáº¥t kháº©u', example: 'Viet Nam exports rice to many countries.' },
                { word: 'Foreign', pos: 'adj', ipa: '/ËˆfÉ’rÉ™n/', definition: 'NÆ°á»›c ngoÃ i', example: 'They receive a lot of foreign investment.' },
                { word: 'Growth', pos: 'n', ipa: '/É¡rÉ™ÊŠÎ¸/', definition: 'Sá»± tÄƒng trÆ°á»Ÿng', example: 'The economy has shown strong growth.' },
                { word: 'Import', pos: 'v', ipa: '/ÉªmËˆpÉ”Ët/', definition: 'Nháº­p kháº©u', example: 'We import coffee from South America.' },
                { word: 'Inflation', pos: 'n', ipa: '/ÉªnËˆfleÉªÊƒn/', definition: 'Láº¡m phÃ¡t', example: 'High inflation is a concern for the government.' },
                { word: 'Market', pos: 'n', ipa: '/ËˆmÉ‘ËkÉªt/', definition: 'Thá»‹ trÆ°á»ng', example: 'They are expanding into the European market.' },
                { word: 'Private', pos: 'adj', ipa: '/ËˆpraÉªvÉ™t/', definition: 'TÆ° nhÃ¢n', example: 'The reform encouraged the private sector.' },
                { word: 'Production', pos: 'n', ipa: '/prÉ™ËˆdÊŒkÊƒn/', definition: 'Sáº£n xuáº¥t', example: 'Car production has increased this year.' },
                { word: 'Reform', pos: 'n', ipa: '/rÉªËˆfÉ”Ëm/', definition: 'Cáº£i cÃ¡ch', example: 'The government introduced a major tax reform.' },
                { word: 'Stable', pos: 'adj', ipa: '/ËˆsteÉªbl/', definition: 'á»”n Ä‘á»‹nh', example: 'The country needs a stable political situation.' },
                { word: 'Trade', pos: 'n', ipa: '/treÉªd/', definition: 'ThÆ°Æ¡ng máº¡i', example: 'International trade is important for the economy.' }
            ],
            // UNIT 8 - TOURISM
            'unit-8': [
                { word: 'Accommodation', pos: 'n', ipa: '/É™ËŒkÉ’mÉ™ËˆdeÉªÊƒn/', definition: 'Chá»— á»Ÿ', example: 'We are looking for cheap accommodation near the beach.' },
                { word: 'Attraction', pos: 'n', ipa: '/É™ËˆtrÃ¦kÊƒn/', definition: 'Äiá»ƒm thu hÃºt', example: 'Ha Long Bay is a major tourist attraction.' },
                { word: 'Backpacking', pos: 'n', ipa: '/ËˆbÃ¦kpÃ¦kÉªÅ‹/', definition: 'Du lá»‹ch ba lÃ´ (bá»¥i)', example: 'Backpacking across Europe is a popular activity.' },
                { word: 'Climate', pos: 'n', ipa: '/ËˆklaÉªmÉ™t/', definition: 'KhÃ­ háº­u', example: 'The tropical climate is very hot and humid.' },
                { word: 'Culture', pos: 'n', ipa: '/ËˆkÊŒltÊƒÉ™(r)/', definition: 'VÄƒn hÃ³a', example: 'She is interested in learning about foreign culture.' },
                { word: 'Ecotourism', pos: 'n', ipa: '/ËˆiËkÉ™ÊŠtÊŠÉ™rÉªzÉ™m/', definition: 'Du lá»‹ch sinh thÃ¡i', example: 'Ecotourism aims to protect natural areas.' },
                { word: 'Exotic', pos: 'adj', ipa: '/ÉªÉ¡ËˆzÉ’tÉªk/', definition: 'Ká»³ láº¡, Ä‘á»™c Ä‘Ã¡o', example: 'They serve a lot of exotic fruit drinks.' },
                { word: 'Facility', pos: 'n', ipa: '/fÉ™ËˆsÉªlÉ™ti/', definition: 'CÆ¡ sá»Ÿ váº­t cháº¥t', example: 'The hotel has excellent sports facilities.' },
                { word: 'Historical', pos: 'adj', ipa: '/hÉªËˆstÉ’rÉªkl/', definition: 'Thuá»™c vá» lá»‹ch sá»­', example: 'We visited several historical sites in the city.' },
                { word: 'Package tour', pos: 'n', ipa: '/ËˆpÃ¦kÉªdÊ’ tÊŠÉ™(r)/', definition: 'Chuyáº¿n du lá»‹ch trá»n gÃ³i', example: 'A package tour includes flights and accommodation.' },
                { word: 'Resort', pos: 'n', ipa: '/rÉªËˆzÉ”Ët/', definition: 'Khu nghá»‰ dÆ°á»¡ng', example: 'We stayed at a luxury resort by the sea.' },
                { word: 'Sightseeing', pos: 'n', ipa: '/ËˆsaÉªtsiËÉªÅ‹/', definition: 'Tham quan', example: 'We spent the afternoon sightseeing.' },
                { word: 'Sustainable', pos: 'adj', ipa: '/sÉ™ËˆsteÉªnÉ™bl/', definition: 'Bá»n vá»¯ng', example: 'Sustainable tourism helps local communities.' },
                { word: 'Tourist', pos: 'n', ipa: '/ËˆtÊŠÉ™rÉªst/', definition: 'KhÃ¡ch du lá»‹ch', example: 'The city attracts millions of tourists every year.' },
                { word: 'Visa', pos: 'n', ipa: '/ËˆviËzÉ™/', definition: 'Thá»‹ thá»±c', example: 'You need a visa to enter that country.' }
            ],
            // UNIT 9 - PROTECTING THE ENVIRONMENT
            'unit-9': [
                { word: 'Air pollution', pos: 'n', ipa: '/ËˆeÉ™ pÉ™luËÊƒn/', definition: 'Ã” nhiá»…m khÃ´ng khÃ­', example: 'Air pollution is a major problem in big cities.' },
                { word: 'Climate change', pos: 'n', ipa: '/ËˆklaÉªmÉ™t tÊƒeÉªndÊ’/', definition: 'Biáº¿n Ä‘á»•i khÃ­ háº­u', example: 'Climate change is affecting weather patterns.' },
                { word: 'Conservation', pos: 'n', ipa: '/ËŒkÉ’nsÉ™ËˆveÉªÊƒn/', definition: 'Sá»± báº£o tá»“n', example: 'Wildlife conservation is very important.' },
                { word: 'Deforestation', pos: 'n', ipa: '/ËŒdiËfÉ’rÉªËˆsteÉªÊƒn/', definition: 'PhÃ¡ rá»«ng', example: 'Deforestation leads to soil erosion.' },
                { word: 'Ecosystem', pos: 'n', ipa: '/ËˆiËkÉ™ÊŠsÉªstÉ™m/', definition: 'Há»‡ sinh thÃ¡i', example: 'The coral reef is a fragile ecosystem.' },
                { word: 'Environment', pos: 'n', ipa: '/ÉªnËˆvaÉªrÉ™nmÉ™nt/', definition: 'MÃ´i trÆ°á»ng', example: 'We must protect the natural environment.' },
                { word: 'Fossil fuel', pos: 'n', ipa: '/ËˆfÉ’sl fjuËÉ™l/', definition: 'NhiÃªn liá»‡u hoÃ¡ tháº¡ch', example: 'Burning fossil fuels causes air pollution.' },
                { word: 'Global warming', pos: 'n', ipa: '/ËŒÉ¡lÉ™ÊŠbl ËˆwÉ”ËmÉªÅ‹/', definition: 'Sá»± nÃ³ng lÃªn toÃ n cáº§u', example: 'Global warming is increasing sea levels.' },
                { word: 'Habitat', pos: 'n', ipa: '/ËˆhÃ¦bÉªtÃ¦t/', definition: 'MÃ´i trÆ°á»ng sá»‘ng', example: 'The forest is the natural habitat of many animals.' },
                { word: 'Litter', pos: 'n', ipa: '/ËˆlÉªtÉ™(r)/', definition: 'RÃ¡c tháº£i', example: 'Please donâ€™t drop litter in the street.' },
                { word: 'Recycle', pos: 'v', ipa: '/ËŒriËËˆsaÉªkl/', definition: 'TÃ¡i cháº¿', example: 'We should recycle all plastic bottles.' },
                { word: 'Renewable', pos: 'adj', ipa: '/rÉªËˆnjuËÉ™bl/', definition: 'CÃ³ thá»ƒ tÃ¡i táº¡o', example: 'Solar power is a renewable energy source.' },
                { word: 'Threat', pos: 'n', ipa: '/Î¸ret/', definition: 'Má»‘i Ä‘e dá»a', example: 'Pollution poses a threat to public health.' },
                { word: 'Toxic', pos: 'adj', ipa: '/ËˆtÉ’ksÉªk/', definition: 'Äá»™c háº¡i', example: 'Toxic chemicals were dumped into the river.' },
                { word: 'Waste', pos: 'n', ipa: '/weÉªst/', definition: 'Cháº¥t tháº£i', example: 'The factory produces a lot of industrial waste.' }
            ],
            // UNIT 10 - COMMUNITY SERVICES
            'unit-10': [
                { word: 'Campaign', pos: 'n', ipa: '/kÃ¦mËˆpeÉªn/', definition: 'Chiáº¿n dá»‹ch', example: 'They launched a campaign to clean up the park.' },
                { word: 'Community', pos: 'n', ipa: '/kÉ™ËˆmjuËnÉ™ti/', definition: 'Cá»™ng Ä‘á»“ng', example: 'She works hard for her local community.' },
                { word: 'Volunteer', pos: 'v, n', ipa: '/ËŒvÉ’lÉ™nËˆtÉªÉ™(r)/', definition: 'TÃ¬nh nguyá»‡n, ngÆ°á»i tÃ¬nh nguyá»‡n', example: 'I volunteer at the hospital every week.' },
                { word: 'Charity', pos: 'n', ipa: '/ËˆtÊƒÃ¦rÉ™ti/', definition: 'Tá»« thiá»‡n', example: 'We donated money to a children\'s charity.' },
                { word: 'Support', pos: 'v, n', ipa: '/sÉ™ËˆpÉ”Ët/', definition: 'á»¦ng há»™, sá»± á»§ng há»™', example: 'The school offers great support to students.' },
                { word: 'Benefit', pos: 'v, n', ipa: '/ËˆbenÉªfÉªt/', definition: 'CÃ³ lá»£i, lá»£i Ã­ch', example: 'This program will benefit the whole town.' } 
            ]
        }; 
        // ====================================================================================================

        // Global constants for Practice Tabs
        const MAX_AUDIO_HUNT_ROUNDS = 10;
        let audioHuntRounds = [];
        let audioHuntRound = 1;
        let audioHuntScore = 0;
        let audioHuntTimerInterval;
        let currentCorrectWord = '';
        let isFirstTry = true;
        
        const MAX_BLANK_ROUNDS = 10;
        let blankQuizRounds = [];
        let blankCurrentRound = 0;
        let blankScore = 0;
        let blankCorrectWord = '';


        // DOM elements
        const unitButtons = document.querySelectorAll('.unit-button');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Flashcard elements
        const cardContainer = document.getElementById('flashcard');
        const flipBtn = document.getElementById('flip-card-btn');
        const prevBtn = document.getElementById('prev-card-btn');
        const nextBtn = document.getElementById('next-card-btn');
        const cardWord = document.getElementById('card-word');
        const cardPos = document.getElementById('card-pos');
        const cardIPAFront = document.getElementById('card-ipa-front');
        const cardDefinition = document.getElementById('card-definition');
        const cardIPA = document.getElementById('card-ipa');
        const cardExample = document.getElementById('card-example');
        const cardCounter = document.getElementById('card-counter');

        // Quiz elements
        const quizQuestionEl = document.getElementById('quiz-question');
        const quizOptionsEl = document.getElementById('quiz-options');
        const quizNextBtn = document.getElementById('quiz-next-btn');
        const quizMessageEl = document.getElementById('quiz-message');

        // Matching Game elements
        let shuffledEnglish = [];
        let shuffledVietnamese = [];
        let currentMatch = {};
        let selectedCard = null;
        let matchGameState = 'playing';
        const englishColMatch = document.getElementById('english-col-match');
        const vietnameseColMatch = document.getElementById('vietnamese-col-match');
        const checkBtnMatch = document.getElementById('check-btn-match');
        const resetBtnMatch = document.getElementById('reset-btn-match');
        const matchMessageBox = document.getElementById('match-message-box');

        // Audio Hunt elements
        const audioHuntSpeaker = document.getElementById('audioHuntSpeaker');
        const audioHuntScoreEl = document.getElementById('audioHuntScore');
        const audioHuntRoundEl = document.getElementById('audioHuntRound');
        const audioHuntTimerEl = document.getElementById('audioHuntTimer');
        const audioHuntMessageEl = document.getElementById('audioHuntMessage');
        const audioHuntWordGrid = document.getElementById('audioHuntWordGrid');
        const audioHuntGameover = document.getElementById('audioHuntGameover');
        const audioHuntFinalScore = document.getElementById('audioHuntFinalScore');

        // Fill in Blanks elements
        const blankSentenceEl = document.getElementById('blank-sentence');
        const blankInputEl = document.getElementById('blank-input');
        const blankCheckBtn = document.getElementById('blank-check-btn');
        const blankNextBtn = document.getElementById('blank-next-btn');
        const blankMessageEl = document.getElementById('blank-message');
        const blankScoreEl = document.getElementById('blank-score');
        const blankProgressEl = document.getElementById('blank-progress');

        // Word Puzzle (Tetris/Falling Letters) elements
        const gameArea = document.getElementById("gameArea-word-puzzle"); 
        const dropZone = document.getElementById("dropZone-word-puzzle"); 
        const message = document.getElementById("message-word-puzzle"); 
        const resetBtn = document.getElementById("resetBtn-word-puzzle"); 
        const info = document.getElementById("info-word-puzzle"); 
        const checkBtnWordPuzzle = document.getElementById("checkBtn-word-puzzle");
        const dropSound = document.getElementById("dropSound");
        const successSound = document.getElementById("successSound");
        let currentWordPuzzle = {};
        const colors = ["#FF5733","#33CFFF","#FF33A6","#33FF57","#FF8F33","#8F33FF","#33FFD7","#FFD733"];
        
        // NEW: Game Constants & State for Tetris
        const GRID_WIDTH = 10;
        const GRID_HEIGHT = 10;
        const DROP_INTERVAL = 200; // Updated to 200ms
        const distractorLetters = 'EAIOTNRSLDCMFPHGVUYWBKXZQJ'; // Added more letters for noise

        let currentBlock = null; // {letter: 'A', x: 4, y: 0, color: '#...', isRequired: true}
        let currentWordLetters = []; // List of required letters
        let requiredLettersIndex = 0; // Index to track the next required letter to spawn
        let lockedBlocks = []; // Array of locked block objects: {id: 1, letter: 'A', x: 4, y: 9, color: '#...', isUsed: false, isRequired: true}
        let blockIdCounter = 0; // To give unique ID to each locked block
        let wordPuzzleInterval;
        let touchStartX = 0;
        let touchStartY = 0;


        // HÃ m Utility function
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // HÃ m chung
        function selectUnit(unitId) {
            currentUnit = unitId;
            currentCardIndex = 0;
            const unitName = `UNIT ${unitId.split('-')[1]} - ${getUnitTitle(unitId)}`;
            document.getElementById('unit-title').textContent = unitName;
            unitButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.unit === unitId) {
                    btn.classList.add('active');
                }
            });
            // Táº£i láº¡i ná»™i dung tab hiá»‡n táº¡i khi Ä‘á»•i Unit
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab) {
                switchTab(activeTab.dataset.tab);
            } else {
                // Máº·c Ä‘á»‹nh chá»n Flashcard
                switchTab('flashcard');
            }
        }

        function getUnitTitle(unitId) {
            switch(unitId) {
                case 'unit-1': return 'FAMILY LIFE';
                case 'unit-2': return 'CLOTHING';
                case 'unit-3': return 'MUSIC';
                case 'unit-4': return 'SPECIAL FOODS';
                case 'unit-5': return 'OUR HERITAGE';
                case 'unit-6': return 'GENDER EQUALITY';
                case 'unit-7': return 'ECONOMIC REFORMS IN VIET NAM';
                case 'unit-8': return 'TOURISM';
                case 'unit-9': return 'PROTECTING THE ENVIRONMENT';
                case 'unit-10': return 'COMMUNITY SERVICES';
                default: return '';
            }
        }

        function switchTab(tabId) {
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active');
                }
            });
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });

            const activeContent = document.getElementById(`${tabId}-tab`);
            if (activeContent) {
                activeContent.classList.remove('hidden');

                if (tabId === 'flashcard') {
                    displayFlashcard(currentUnit, currentCardIndex);
                } else if (tabId === 'vocabulary-list') {
                    displayVocabularyList(currentUnit);
                } else if (tabId === 'practice') {
                    // KÃ­ch hoáº¡t sub-tab máº·c Ä‘á»‹nh (Quiz)
                    const activeSubTab = document.querySelector('.practice-sub-tab-button.active');
                    if (activeSubTab) {
                        switchPracticeSubTab(activeSubTab.dataset.practiceTab);
                    } else {
                         switchPracticeSubTab('quiz');
                    }
                }
            }
        }

        // START: Practice Sub-Tab Logic
        const practiceSubTabButtons = document.querySelectorAll('.practice-sub-tab-button');
        const subTabContents = document.querySelectorAll('.practice-sub-content');

        function switchPracticeSubTab(subTabId) {
            // Dá»n dáº¹p state cá»§a game Word Puzzle Tetris 
            if (wordPuzzleInterval) clearInterval(wordPuzzleInterval); 

            practiceSubTabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.practiceTab === subTabId) {
                    btn.classList.add('active');
                }
            });
            subTabContents.forEach(content => {
                content.classList.add('hidden');
            });

            if (subTabId === 'quiz') {
                document.getElementById('practice-quiz-content').classList.remove('hidden');
                loadQuiz(currentUnit);
            } else if (subTabId === 'match-game') {
                // Logic cho Ná»‘i Tá»«
                document.getElementById('practice-word-puzzle-content').classList.remove('hidden');
                initMatchGame();
            } else if (subTabId === 'audio-hunt') {
                // Logic cho Audio Hunt
                document.getElementById('practice-audio-hunt-content').classList.remove('hidden');
                initAudioHunt();
            } else if (subTabId === 'fill-in-blanks') {
                // Logic cho Äiá»n Tá»«
                document.getElementById('practice-fill-in-blanks-content').classList.remove('hidden');
                initFillInBlanks();
            } else if (subTabId === 'word-puzzle-tetris') {
                // NEW: Logic cho Xáº¿p Chá»¯ (Tetris)
                document.getElementById('practice-word-puzzle-tetris-content').classList.remove('hidden');
                initWordPuzzleTetris();
            }
        }

        // END: Practice Sub-Tab Logic

        // START: Flashcard Logic
        function displayFlashcard(unitId, index) {
            const vocabList = vocabularyData[unitId];
            if (!vocabList || vocabList.length === 0) {
                cardWord.textContent = "ChÆ°a cÃ³ dá»¯ liá»‡u tá»« vá»±ng.";
                cardDefinition.textContent = "";
                cardPos.textContent = "";
                cardIPAFront.textContent = ""; // Reset IPA front
                cardIPA.textContent = "";
                cardExample.textContent = "";
                cardCounter.textContent = "";
                return;
            }
            const wordData = vocabList[index];

            // Äáº·t láº¡i tháº» vá» máº·t trÆ°á»›c vÃ  khÃ´ng láº­t
            cardContainer.classList.remove('flipped'); 

            // Cáº­p nháº­t ná»™i dung máº·t trÆ°á»›c
            cardWord.textContent = wordData.word;
            cardPos.textContent = `(${wordData.pos})`;
            cardIPAFront.textContent = wordData.ipa;

            // Cáº­p nháº­t ná»™i dung máº·t sau
            cardDefinition.textContent = wordData.definition;
            cardIPA.textContent = wordData.ipa;
            cardExample.textContent = wordData.example;

            // Cáº­p nháº­t bá»™ Ä‘áº¿m
            cardCounter.textContent = `Tháº» ${index + 1} / ${vocabList.length}`;

            // Cáº­p nháº­t tráº¡ng thÃ¡i nÃºt
            prevBtn.disabled = (index === 0);
            nextBtn.disabled = (index === vocabList.length - 1);
        }

        flipBtn.addEventListener('click', () => {
            cardContainer.classList.toggle('flipped');
        });

        prevBtn.addEventListener('click', () => {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                displayFlashcard(currentUnit, currentCardIndex);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentCardIndex < vocabularyData[currentUnit].length - 1) {
                currentCardIndex++;
                displayFlashcard(currentUnit, currentCardIndex);
            }
        });

        // END: Flashcard Logic


        // START: Vocabulary List Logic
        function displayVocabularyList(unitId) {
            const vocabList = vocabularyData[unitId];
            const tableContainer = document.getElementById('vocab-table-container');

            if (!vocabList || vocabList.length === 0) {
                tableContainer.innerHTML = `<p class="text-gray-500">Unit nÃ y chÆ°a cÃ³ dá»¯ liá»‡u tá»« vá»±ng.</p>`;
                return;
            }

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/4">Tá»« Vá»±ng</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/4">Loáº¡i tá»« / PhÃ¡t Ã¢m</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/4">NghÄ©a</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/4">VÃ­ dá»¥</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            vocabList.forEach(item => {
                // NEW: ThÃªm biá»ƒu tÆ°á»£ng loa vÃ  sá»± kiá»‡n onclick
                tableHTML += `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                            <div class="flex items-center space-x-2">
                                <span>${item.word}</span>
                                <i class="fas fa-volume-up text-blue-500 cursor-pointer hover:text-blue-700 transition" 
                                   onclick="speakWord('${item.word.replace(/'/g, "\\'")}')"></i> 
                            </div>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                            <span class="font-semibold text-blue-600">(${item.pos})</span><br>
                            <span class="font-mono italic text-sm text-gray-700">${item.ipa}</span>
                        </td>
                        <td class="px-3 py-3 whitespace-pre-wrap text-sm text-gray-700">${item.definition}</td>
                        <td class="px-3 py-3 whitespace-pre-wrap text-sm italic text-gray-600">${item.example}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }
        // END: Vocabulary List Logic


        // START: Quiz Logic
        function getQuizWord(unitId) {
            const vocabList = vocabularyData[unitId];
            if (!vocabList || vocabList.length < 4) return null; // Cáº§n Ã­t nháº¥t 4 tá»« Ä‘á»ƒ táº¡o 4 Ä‘Ã¡p Ã¡n

            // 1. Chá»n ngáº«u nhiÃªn 1 tá»« lÃ m tá»« má»¥c tiÃªu
            const targetWord = vocabList[Math.floor(Math.random() * vocabList.length)];
            const question = targetWord.definition;

            // 2. Láº¥y 3 tá»« sai ngáº«u nhiÃªn
            let incorrectOptions = [];
            let pool = vocabList.filter(item => item.word !== targetWord.word);
            pool = shuffleArray(pool);
            incorrectOptions = pool.slice(0, 3).map(item => item.word);

            // 3. Trá»™n Ä‘Ã¡p Ã¡n Ä‘Ãºng vÃ o
            const options = shuffleArray([targetWord.word, ...incorrectOptions]);

            return { question, target: targetWord.word, options };
        }

        function loadQuiz(unitId) {
            quizMessageEl.textContent = "";
            quizNextBtn.classList.add('hidden');
            quizOptionsEl.innerHTML = "";

            const quizData = getQuizWord(unitId);
            if (!quizData) {
                quizQuestionEl.textContent = "KhÃ´ng Ä‘á»§ tá»« vá»±ng (cáº§n Ã­t nháº¥t 4 tá»«) Ä‘á»ƒ táº¡o tráº¯c nghiá»‡m.";
                return;
            }

            currentQuizWord = quizData.target;
            quizQuestionEl.textContent = `TÃ¬m tá»« tiáº¿ng Anh cho nghÄ©a: "${quizData.question}"`;
            quizOptions = quizData.options;

            quizOptions.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'quiz-option w-full p-4 border-2 border-gray-300 rounded-lg text-left text-lg font-medium hover:bg-gray-100 transition duration-150';
                button.textContent = option;
                button.setAttribute('data-answer', option);
                button.onclick = () => checkQuizAnswer(button, option);
                quizOptionsEl.appendChild(button);
            });
        }

        function checkQuizAnswer(selectedButton, selectedAnswer) {
            // NgÄƒn cháº·n chá»n láº¡i
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.onclick = null;
            });

            if (selectedAnswer === currentQuizWord) {
                selectedButton.classList.add('correct');
                quizMessageEl.textContent = 'ChÃ­nh xÃ¡c! ğŸ‰';
                quizMessageEl.style.color = 'green';
                score += 1;
            } else {
                selectedButton.classList.add('incorrect');
                quizMessageEl.textContent = `Sai rá»“i. ÄÃ¡p Ã¡n Ä‘Ãºng lÃ : "${currentQuizWord}"`;
                quizMessageEl.style.color = 'red';
                // Highlight Ä‘Ã¡p Ã¡n Ä‘Ãºng
                document.querySelectorAll('.quiz-option').forEach(btn => {
                    if (btn.getAttribute('data-answer') === currentQuizWord) {
                        btn.classList.add('correct');
                    }
                });
            }

            quizNextBtn.classList.remove('hidden');
        }

        quizNextBtn.addEventListener('click', () => {
            loadQuiz(currentUnit);
        });

        // END: Quiz Logic


        // START: Logic cho BÃ i Ná»‘i Tá»« (Matching Game)
        function initMatchGame() {
            // Láº¥y dá»¯ liá»‡u tá»« vá»±ng tá»« Unit hiá»‡n táº¡i vÃ  thÃªm originalIndex
            const fullVocabList = vocabularyData[currentUnit].map((item, index) => ({ originalIndex: index, en: item.word, vi: item.definition }));

            // Giá»›i háº¡n sá»‘ lÆ°á»£ng tá»« xuá»‘ng tá»‘i Ä‘a 8 tá»«
            const MAX_WORDS = 8;
            let vocabListToUse;
            if (fullVocabList.length > MAX_WORDS) {
                // XÃ¡o trá»™n toÃ n bá»™ danh sÃ¡ch vÃ  chá»n MAX_WORDS tá»« Ä‘áº§u tiÃªn
                vocabListToUse = shuffleArray([...fullVocabList]).slice(0, MAX_WORDS);
            } else {
                vocabListToUse = fullVocabList;
            }

            if (vocabListToUse.length < 2) {
                updateMatchMessage("Unit nÃ y khÃ´ng Ä‘á»§ tá»« vá»±ng (cáº§n Ã­t nháº¥t 2 tá»«) Ä‘á»ƒ chÆ¡i BÃ i Ná»‘i Tá»«.", 'error');
                englishColMatch.innerHTML = `<h2 class="text-xl font-semibold text-blue-700 mb-4 border-b pb-2">Tá»« Tiáº¿ng Anh</h2>`;
                vietnameseColMatch.innerHTML = `<h2 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2">NghÄ©a Tiáº¿ng Viá»‡t</h2>`;
                checkBtnMatch.disabled = true;
                return;
            }

            // Reset state
            currentMatch = {};
            selectedCard = null;
            matchGameState = 'playing';
            matchMessageBox.classList.add('hidden');
            matchMessageBox.innerHTML = '';
            checkBtnMatch.disabled = false;

            // Táº¡o danh sÃ¡ch tá»« Ä‘Ã£ xÃ¡o trá»™n Tá»ª DANH SÃCH ÄÃƒ GIá»šI Háº N
            shuffledEnglish = vocabListToUse.map(item => ({ text: item.en, originalIndex: item.originalIndex }));
            shuffledVietnamese = vocabListToUse.map(item => ({ text: item.vi, originalIndex: item.originalIndex }));
            shuffleArray(shuffledEnglish);
            shuffleArray(shuffledVietnamese);

            // Render giao diá»‡n
            englishColMatch.innerHTML = `<h2 class="text-xl font-semibold text-blue-700 mb-4 border-b pb-2">Tá»« Tiáº¿ng Anh</h2>`;
            vietnameseColMatch.innerHTML = `<h2 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2">NghÄ©a Tiáº¿ng Viá»‡t</h2>`;

            shuffledEnglish.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'card-item p-3 border-2 border-blue-200 rounded-lg text-lg font-medium text-blue-900';
                card.id = `en-${item.originalIndex}`;
                card.textContent = item.text;
                card.setAttribute('data-type', 'en');
                card.setAttribute('data-index', item.originalIndex);
                card.onclick = handleCardClick;
                englishColMatch.appendChild(card);
            });

            shuffledVietnamese.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'card-item p-3 border-2 border-green-200 rounded-lg text-lg font-medium text-green-900';
                card.id = `vi-${item.originalIndex}`;
                card.textContent = item.text;
                card.setAttribute('data-type', 'vi');
                card.setAttribute('data-index', item.originalIndex);
                card.onclick = handleCardClick;
                vietnameseColMatch.appendChild(card);
            });
        }

        function handleCardClick(event) {
            if (matchGameState !== 'playing') return;

            const clickedCard = event.currentTarget;
            const cardType = clickedCard.getAttribute('data-type');
            const cardIndex = clickedCard.getAttribute('data-index');

            if (clickedCard.classList.contains('matched')) return; // Bá» qua tháº» Ä‘Ã£ khá»›p

            // TrÆ°á»ng há»£p 1: Tháº» Ä‘Ã£ Ä‘Æ°á»£c chá»n -> Bá» chá»n
            if (selectedCard && selectedCard.id === clickedCard.id) {
                selectedCard.classList.remove('selected');
                selectedCard = null;
                updateMatchMessage("ÄÃ£ bá» chá»n tháº».", 'info');
                return;
            }

            // TrÆ°á»ng há»£p 2: ChÆ°a cÃ³ tháº» nÃ o Ä‘Æ°á»£c chá»n hoáº·c tháº» má»›i cÃ¹ng loáº¡i -> Chá»n tháº» nÃ y
            if (!selectedCard || selectedCard.getAttribute('data-type') === cardType) {
                // Náº¿u cÃ³ tháº» cÃ¹ng loáº¡i Ä‘Ã£ chá»n, bá» chá»n tháº» cÅ©
                if (selectedCard) {
                    selectedCard.classList.remove('selected');
                }
                
                selectedCard = clickedCard;
                selectedCard.classList.add('selected');
                updateMatchMessage(`ÄÃ£ chá»n tháº» ${cardType === 'en' ? 'tiáº¿ng Anh' : 'tiáº¿ng Viá»‡t'}. Chá»n tháº» cÃ²n láº¡i Ä‘á»ƒ ghÃ©p cáº·p.`, 'info');
                return;
            }

            // TrÆ°á»ng há»£p 3: ÄÃ£ cÃ³ 1 tháº» khÃ¡c loáº¡i Ä‘Æ°á»£c chá»n -> Táº¡o cáº·p
            if (selectedCard && selectedCard.getAttribute('data-type') !== cardType) {
                const [wordCard, meaningCard] = selectedCard.getAttribute('data-type') === 'en' ? [selectedCard, clickedCard] : [clickedCard, selectedCard];
                const enIndex = wordCard.getAttribute('data-index');
                const viIndex = meaningCard.getAttribute('data-index');

                // VÃ²ng láº·p phá»©c táº¡p Ä‘á»ƒ tÃ¬m vÃ  reset cÃ¡c cáº·p bá»‹ unmatch/thay tháº¿
                const keysToUpdate = [];
                for (const [key, value] of Object.entries(currentMatch)) {
                    // Tháº» tiáº¿ng Anh nÃ y Ä‘Ã£ Ä‘Æ°á»£c ghÃ©p vá»›i tháº» tiáº¿ng Viá»‡t khÃ¡c. Reset tháº» tiáº¿ng Viá»‡t cÅ©.
                    if (key == enIndex) { 
                        keysToUpdate.push(key); 
                        const oldViCard = document.getElementById(`vi-${value}`); 
                        if (oldViCard) oldViCard.classList.remove('selected');
                    }
                    // Tháº» tiáº¿ng Viá»‡t nÃ y Ä‘Ã£ Ä‘Æ°á»£c ghÃ©p vá»›i tháº» tiáº¿ng Anh khÃ¡c. Reset tháº» tiáº¿ng Anh cÅ©.
                    if (value == viIndex) { 
                        keysToUpdate.push(key); 
                        const oldEnCard = document.getElementById(`en-${key}`); 
                        if (oldEnCard) oldEnCard.classList.remove('selected');
                    }
                }
                
                // XÃ³a cÃ¡c cáº·p bá»‹ thay tháº¿
                keysToUpdate.forEach(key => delete currentMatch[key]);

                // XÃ³a highlight cá»§a 2 tháº» Ä‘ang ghÃ©p náº¿u chÃºng Ä‘Ã£ tá»«ng Ä‘Æ°á»£c ghÃ©p
                wordCard.classList.remove('selected');
                meaningCard.classList.remove('selected');

                // Táº¡o cáº·p má»›i
                currentMatch[enIndex] = viIndex;
                wordCard.classList.add('selected');
                meaningCard.classList.add('selected');

                selectedCard = null; // Reset tháº» Ä‘Ã£ chá»n
                updateMatchMessage("ÄÃ£ ghÃ©p cáº·p thÃ nh cÃ´ng! Nháº¥n 'Kiá»ƒm Tra Káº¿t Quáº£' khi hoÃ n thÃ nh.", 'success');
                return;
            }
        }

        // HÃ m kiá»ƒm tra káº¿t quáº£
        function checkMatchAnswers() {
            const totalMatches = shuffledEnglish.length; // Tá»•ng sá»‘ cáº·p cáº§n ghÃ©p

            if (Object.keys(currentMatch).length !== totalMatches) {
                updateMatchMessage(`Báº¡n cáº§n ghÃ©p Ä‘á»§ ${totalMatches} cáº·p trÆ°á»›c khi kiá»ƒm tra.`, 'warning');
                return;
            }

            matchGameState = 'finished';
            checkBtnMatch.disabled = true;

            // XÃ³a háº¿t tráº¡ng thÃ¡i selected (xanh dÆ°Æ¡ng)
            document.querySelectorAll('.card-item').forEach(card => {
                card.classList.remove('selected');
                card.onclick = null; // NgÄƒn cháº·n tÆ°Æ¡ng tÃ¡c tiáº¿p
            });

            let correctCount = 0;

            // Láº·p qua táº¥t cáº£ cÃ¡c tháº» tiáº¿ng Anh
            shuffledEnglish.forEach(enItem => {
                const enIndex = enItem.originalIndex.toString();
                const wordCard = document.getElementById(`en-${enIndex}`);
                const viIndex = currentMatch[enIndex]; // Láº¥y index cá»§a tháº» tiáº¿ng Viá»‡t Ä‘Ã£ ghÃ©p

                if (!viIndex) return; // Bá» qua náº¿u khÃ´ng Ä‘Æ°á»£c ghÃ©p

                const meaningCard = document.getElementById(`vi-${viIndex}`);
                
                // So sÃ¡nh original index
                if (enIndex == viIndex) {
                    // ÄÃºng
                    wordCard.classList.add('correct', 'matched');
                    meaningCard.classList.add('correct', 'matched');
                    correctCount++;
                } else {
                    // Sai
                    wordCard.classList.add('incorrect');
                    meaningCard.classList.add('incorrect');
                }
            });
            
            // Hiá»ƒn thá»‹ káº¿t quáº£ cuá»‘i cÃ¹ng
            const percentage = Math.round((correctCount / totalMatches) * 100);
            let messageText = `Káº¿t quáº£ cá»§a báº¡n: ${correctCount}/${totalMatches} (${percentage}%)`;
            let type = 'success';
            if (percentage < 50) type = 'error';
            else if (percentage < 100) type = 'warning';

            updateMatchMessage(messageText, type);
        }

        // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o
        function updateMatchMessage(text, type) {
            matchMessageBox.innerText = text;
            matchMessageBox.classList.remove('hidden', 'bg-red-100', 'bg-yellow-100', 'bg-blue-100', 'bg-green-100', 'text-red-800', 'text-yellow-800', 'text-blue-800', 'text-green-800');
            switch(type) {
                case 'success':
                    matchMessageBox.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'warning':
                    matchMessageBox.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'error':
                    matchMessageBox.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'info':
                default:
                    matchMessageBox.classList.add('bg-blue-100', 'text-blue-800');
                    break;
            }
        }
        // END: Logic cho BÃ i Ná»‘i Tá»«

        
        // START: Logic cho BÃ i Nghe & Chá»n (Audio Hunt)
        const audioHuntTimerDuration = 3; // 3 seconds per round
        function getIncorrectOptions(vocabList, correctWord, count) {
            let incorrectWords = vocabList
                .map(item => item.word)
                .filter(word => word !== correctWord);

            // XÃ¡o trá»™n vÃ  cáº¯t
            return shuffleArray(incorrectWords).slice(0, count);
        }

        function generateAudioHuntRounds(unitId) {
            const vocabList = vocabularyData[unitId];
            if (!vocabList || vocabList.length < 6) return null; // Cáº§n Ã­t nháº¥t 6 tá»« (1 Ä‘Ãºng + 5 sai)

            const shuffledList = shuffleArray([...vocabList]);
            const roundsToGenerate = Math.min(shuffledList.length, MAX_AUDIO_HUNT_ROUNDS);
            const rounds = [];

            for (let i = 0; i < roundsToGenerate; i++) {
                const correctWord = shuffledList[i].word;
                // Láº¥y 5 tá»« sai (hoáº·c Ã­t hÆ¡n náº¿u danh sÃ¡ch ngáº¯n)
                const incorrectOptions = getIncorrectOptions(vocabList, correctWord, 5);
                const options = shuffleArray([correctWord, ...incorrectOptions]);
                
                rounds.push({
                    audio: correctWord,
                    options: options.slice(0, 6) // Chá»‰ láº¥y tá»‘i Ä‘a 6 options
                });
            }
            return rounds;
        }

        function initAudioHunt() {
            audioHuntRounds = generateAudioHuntRounds(currentUnit);

            if (!audioHuntRounds || audioHuntRounds.length < 5) {
                audioHuntMessageEl.textContent = "Unit nÃ y khÃ´ng Ä‘á»§ tá»« vá»±ng (cáº§n Ã­t nháº¥t 5 tá»«) Ä‘á»ƒ chÆ¡i game Nghe & Chá»n.";
                audioHuntMessageEl.classList.add('text-red-600');
                audioHuntWordGrid.innerHTML = '';
                audioHuntSpeaker.classList.add('hidden');
                document.getElementById('audioHuntTopBar')?.classList.add('hidden');
                return;
            }
            // Reset game state
            audioHuntRound = 1;
            audioHuntScore = 0;
            audioHuntGameover.classList.add('hidden');
            audioHuntSpeaker.classList.remove('hidden');
            document.getElementById('audioHuntTopBar')?.classList.remove('hidden');

            loadAudioHuntRound();
        }

        function nextAudioHuntRound() {
            audioHuntRound++;
            if (audioHuntRound > MAX_AUDIO_HUNT_ROUNDS || audioHuntRound > audioHuntRounds.length) {
                endAudioHuntGame();
            } else {
                loadAudioHuntRound();
            }
        }

        function startAudioHuntTimer() {
            let timeLeft = audioHuntTimerDuration;
            audioHuntTimerEl.textContent = timeLeft;
            audioHuntTimerInterval = setInterval(() => {
                timeLeft--;
                audioHuntTimerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(audioHuntTimerInterval);
                    audioHuntTimerEl.textContent = 0;
                    // Disable all options and highlight correct on timeout
                    highlightCorrectAudioHunt(currentCorrectWord, 'Háº¿t giá»!'); 
                    // Disable future clicks for this round
                    audioHuntWordGrid.querySelectorAll('.word-card').forEach(c => c.classList.add("disabled-round-end"));
                    setTimeout(nextAudioHuntRound, 1200);
                }
            }, 1000);
        }

        function highlightCorrectAudioHunt(correctWord, messageText) {
             audioHuntMessageEl.textContent = messageText;
             audioHuntMessageEl.classList.add('text-red-600');
             audioHuntMessageEl.classList.remove('text-green-600');

            audioHuntWordGrid.querySelectorAll('.word-card').forEach(card => {
                if (card.textContent === correctWord) {
                    card.classList.add("bg-green-500");
                    card.classList.remove("bg-white", "hover:bg-blue-50", "text-gray-800");
                } else {
                     card.classList.add("bg-red-500");
                     card.classList.remove("bg-white", "hover:bg-blue-50", "text-gray-800");
                }
            });
        }

        function updateAudioHuntScore() {
            audioHuntScoreEl.textContent = audioHuntScore;
            audioHuntRoundEl.textContent = `${audioHuntRound}/${MAX_AUDIO_HUNT_ROUNDS}`;
        }

        function loadAudioHuntRound() {
            if (audioHuntRound > MAX_AUDIO_HUNT_ROUNDS || audioHuntRound > audioHuntRounds.length) {
                endAudioHuntGame();
                return;
            }
            
            // Clear previous states
            audioHuntWordGrid.innerHTML = '';
            audioHuntMessageEl.textContent = '';
            isFirstTry = true;
            clearInterval(audioHuntTimerInterval); // Reset timer just in case

            const roundData = audioHuntRounds[audioHuntRound - 1];
            currentCorrectWord = roundData.audio;

            // Load cards
            roundData.options.forEach(word => {
                const card = document.createElement('div');
                card.classList.add('word-card', 'p-4', 'bg-white', 'rounded-xl', 'border-2', 'border-gray-200', 'shadow-md', 'text-lg', 'font-semibold', 'text-gray-800', 'cursor-pointer', 'transition', 'duration-200', 'hover:bg-blue-50');
                card.textContent = word;
                card.onclick = () => {
                    if (card.classList.contains("disabled-round-end") || card.classList.contains("bg-red-500")) return; // Ignore if disabled or already wrong guess
                    
                    clearInterval(audioHuntTimerInterval); // Stop timer on selection

                    if (word === currentCorrectWord) {
                        card.classList.add("bg-green-500", "text-white", "correct");
                        card.classList.remove("bg-white", "hover:bg-blue-50", "border-gray-200", "cursor-pointer");

                        // Calculate score based on attempt
                        const scoreGained = isFirstTry ? 10 : 5;
                        audioHuntScore += scoreGained;
                        updateAudioHuntScore();

                        audioHuntMessageEl.textContent = `ChÃ­nh xÃ¡c! (+${scoreGained} Ä‘iá»ƒm) ğŸ‰`;
                        audioHuntMessageEl.classList.add('text-green-600');
                        audioHuntMessageEl.classList.remove('text-red-600');
                        
                        // Disable all and move to next round
                        audioHuntWordGrid.querySelectorAll('.word-card').forEach(c => c.classList.add("disabled-round-end"));
                        setTimeout(nextAudioHuntRound, 1200);

                    } else {
                        // Sai
                        isFirstTry = false;
                        card.classList.add("bg-red-500", "text-white");
                        card.classList.remove("bg-white", "hover:bg-blue-50", "border-gray-200", "cursor-pointer");
                        audioHuntMessageEl.textContent = `Sai. Thá»­ láº¡i hoáº·c nghe láº¡i.`;
                        audioHuntMessageEl.classList.add('text-red-600');
                        audioHuntMessageEl.classList.remove('text-green-600');
                        
                        // Restart timer
                        startAudioHuntTimer();
                    }
                };
                audioHuntWordGrid.appendChild(card);
            });

            updateAudioHuntScore();
            speakWord(currentCorrectWord); // PhÃ¡t Ã¢m láº§n Ä‘áº§u
            startAudioHuntTimer(); // Báº¯t Ä‘áº§u Ä‘áº¿m ngÆ°á»£c
        }

        function endAudioHuntGame() {
            clearInterval(audioHuntTimerInterval);
            audioHuntFinalScore.textContent = audioHuntScore;
            audioHuntGameover.classList.remove('hidden');
            audioHuntWordGrid.innerHTML = '';
            audioHuntSpeaker.classList.add('hidden');
            audioHuntMessageEl.textContent = '';
        }

        // Event Listeners
        audioHuntSpeaker.addEventListener('click', () => {
            if (currentCorrectWord) {
                speakWord(currentCorrectWord);
            }
        });
        document.getElementById('audioHuntRestartBtn').addEventListener('click', initAudioHunt);

        // END: Logic cho BÃ i Nghe & Chá»n


        // START: Logic cho BÃ i Äiá»n Tá»« (Fill in Blanks)
        function generateBlankRounds(unitId) {
            const vocabList = vocabularyData[unitId];
            if (!vocabList || vocabList.length < 5) return null; // Cáº§n Ã­t nháº¥t 5 tá»«

            // Láº¥y ngáº«u nhiÃªn MAX_BLANK_ROUNDS tá»« (hoáº·c max) Ä‘á»ƒ lÃ m cÃ¢u há»i
            const shuffledList = shuffleArray([...vocabList]);
            const roundsToGenerate = Math.min(shuffledList.length, MAX_BLANK_ROUNDS);
            const rounds = [];

            for (let i = 0; i < roundsToGenerate; i++) {
                const item = shuffledList[i];
                // Thay tháº¿ tá»« trong cÃ¢u vÃ­ dá»¥ báº±ng dáº¥u gáº¡ch chÃ¢n (______)
                // Sá»­ dá»¥ng RegExp Ä‘á»ƒ thay tháº¿ cáº£ tá»« vÃ  Ä‘áº£m báº£o khÃ´ng thay tháº¿ nháº§m (gi - global ignore case)
                // KÃ½ tá»± \b Ä‘áº£m báº£o thay tháº¿ toÃ n bá»™ tá»« (word boundary)
                const wordPattern = new RegExp('\\b' + item.word.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') + '\\b', 'gi');
                const sentenceWithBlank = item.example.replace(wordPattern, '______');

                // Náº¿u khÃ´ng cÃ³ sá»± thay tháº¿ nÃ o xáº£y ra, thÃ¬ bá» qua (cÃ¢u vÃ­ dá»¥ khÃ´ng chá»©a tá»«)
                if (sentenceWithBlank.includes('______')) {
                    rounds.push({
                        sentence: sentenceWithBlank,
                        correctWord: item.word,
                        definition: item.definition // ADDED: ThÃªm nghÄ©a tiáº¿ng Viá»‡t
                    });
                }
            }

            // Náº¿u sau khi lá»c váº«n khÃ´ng Ä‘á»§ 5 cÃ¢u
            if (rounds.length < 5) return null;
            return rounds;
        }

        function initFillInBlanks() {
            blankQuizRounds = generateBlankRounds(currentUnit);
            if (!blankQuizRounds) {
                const errorBox = document.getElementById('blank-question-box');
                errorBox.classList.remove('bg-purple-50');
                errorBox.classList.add('bg-red-100');
                blankSentenceEl.innerHTML = `<p class="text-xl font-bold text-red-700">Unit nÃ y khÃ´ng Ä‘á»§ tá»« vá»±ng (cáº§n Ã­t nháº¥t 5 cÃ¢u vÃ­ dá»¥ cÃ³ tá»« vá»±ng) Ä‘á»ƒ chÆ¡i game Äiá»n Tá»«.</p>`;
                blankInputEl.classList.add('hidden');
                blankCheckBtn.classList.add('hidden');
                blankNextBtn.classList.add('hidden');
                blankMessageEl.textContent = '';
                document.getElementById('blank-stats').classList.add('hidden');
                return;
            }

            // Reset state
            blankCurrentRound = 0;
            blankScore = 0;
            blankInputEl.classList.remove('hidden');
            blankCheckBtn.classList.remove('hidden');
            document.getElementById('blank-stats').classList.remove('hidden');
            
            loadBlankQuestion();
        }

        function updateBlankStats() {
            blankScoreEl.textContent = blankScore;
            blankProgressEl.textContent = `${blankCurrentRound + 1}/${MAX_BLANK_ROUNDS}`;

            if (blankCurrentRound >= MAX_BLANK_ROUNDS) {
                 endFillInBlanksGame();
            }
        }

        function loadBlankQuestion() {
            if (blankCurrentRound >= MAX_BLANK_ROUNDS || blankCurrentRound >= blankQuizRounds.length) {
                endFillInBlanksGame();
                return;
            }
            const currentRoundData = blankQuizRounds[blankCurrentRound];
            blankCorrectWord = currentRoundData.correctWord;

            blankSentenceEl.innerHTML = `
                <p class="text-xl font-medium text-gray-800 mb-2">Ã nghÄ©a: <span class="text-purple-700 font-semibold">${currentRoundData.definition}</span></p>
                <p class="text-2xl font-bold text-gray-900 mt-4">${currentRoundData.sentence}</p>
            `;
            blankInputEl.value = '';
            blankInputEl.disabled = false;
            blankCheckBtn.disabled = false;
            blankNextBtn.classList.add('hidden');
            blankMessageEl.textContent = '';
            blankInputEl.focus();
            updateBlankStats();
        }

        function checkBlankAnswer() {
            // Láº¥y tá»« vá»±ng (ignore case)
            const userAnswer = blankInputEl.value.trim().toLowerCase();
            const correctAnswer = blankCorrectWord.trim().toLowerCase();
            const messageBox = document.getElementById('blank-question-box');

            blankInputEl.disabled = true;
            blankCheckBtn.disabled = true;
            blankNextBtn.classList.remove('hidden');

            if (userAnswer === correctAnswer) {
                blankScore += 10;
                blankMessageEl.textContent = 'ChÃ­nh xÃ¡c! (+10 Ä‘iá»ƒm) ğŸ‰';
                blankMessageEl.style.color = 'green';
                messageBox.classList.remove('bg-purple-50', 'bg-red-100');
                messageBox.classList.add('bg-green-100');
            } else {
                blankMessageEl.textContent = `Sai rá»“i. ÄÃ¡p Ã¡n Ä‘Ãºng lÃ : "${blankCorrectWord}"`;
                blankMessageEl.style.color = 'red';
                messageBox.classList.remove('bg-purple-50', 'bg-green-100');
                messageBox.classList.add('bg-red-100');
            }
            
            updateBlankStats();

            // Prepare for next round
            blankCurrentRound++; 

            // Remove flash effect quickly
            setTimeout(() => {
                messageBox.classList.remove('bg-green-100', 'bg-red-100');
                messageBox.classList.add('bg-purple-50');
            }, 500);
        }

        function nextBlankQuestion() {
            // Only proceed if current round is checked (input is disabled)
            if (blankInputEl.disabled) {
                loadBlankQuestion();
            }
        }

        function endFillInBlanksGame() {
            blankSentenceEl.innerHTML = `<p class="text-2xl font-bold text-purple-700">ğŸ‰ HoÃ n thÃ nh bÃ i Äiá»n Tá»«!</p>`;
            blankInputEl.classList.add('hidden');
            blankCheckBtn.classList.add('hidden');
            blankMessageEl.textContent = `Äiá»ƒm cuá»‘i cÃ¹ng cá»§a báº¡n: ${blankScore}`;
            blankMessageEl.style.color = '#5b21b6';
            blankNextBtn.textContent = 'ChÆ¡i Láº¡i';
            blankNextBtn.onclick = initFillInBlanks;
        }

        blankCheckBtn.addEventListener('click', checkBlankAnswer);
        blankNextBtn.addEventListener('click', nextBlankQuestion);
        blankInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (blankInputEl.disabled) {
                    nextBlankQuestion();
                } else {
                    checkBlankAnswer();
                }
            }
        });

        // END: Logic cho BÃ i Äiá»n Tá»«


        // START: Logic cho BÃ i Xáº¿p Chá»¯ (Tetris/Falling Letters)
        // ====================================================================================================

        function drawGrid() {
            gameArea.innerHTML = '';
            
            // Set up grid container style 
            gameArea.style.cssText = `
                display: grid;
                grid-template-columns: repeat(${GRID_WIDTH}, 1fr);
                grid-template-rows: repeat(${GRID_HEIGHT}, 1fr);
                width: 90vw;
                max-width: 300px;
                height: 90vw;
                max-height: 300px;
                margin: 0 auto;
                border-radius: 8px;
                overflow: hidden;
                border: 4px solid #1f2937;
                background-color: #f0f0f0;
            `;

            // Draw all cells (empty, locked, or falling)
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const cell = document.createElement("div");
                    cell.className = "grid-cell";
                    
                    // 1. Find the content for this cell
                    let blockContent = null;
                    
                    // a. Draw Locked Blocks
                    const lockedBlock = lockedBlocks.find(b => b.x === x && b.y === y);
                    if (lockedBlock) {
                        const isUsed = lockedBlock.isUsed ? 'true' : 'false';
                        // Blocks not required (distractors) are drawn slightly dimmer and are not clickable
                        const opacity = lockedBlock.isRequired ? '1' : '0.6';
                        const pointerEvents = lockedBlock.isRequired ? 'auto' : 'none';

                        blockContent = `<div 
                            class="letter-block locked" 
                            data-id="${lockedBlock.id}" 
                            data-used="${isUsed}" 
                            style="background-color: ${lockedBlock.color}; opacity: ${opacity}; pointer-events: ${pointerEvents};"
                            >
                            ${lockedBlock.letter}
                            </div>`;
                    } 
                    // b. Draw Falling Block
                    else if (currentBlock && currentBlock.x === x && currentBlock.y === y) {
                        blockContent = `<div class="letter-block falling" style="background-color: ${currentBlock.color};">${currentBlock.letter}</div>`;
                    }

                    if (blockContent) {
                        cell.innerHTML = blockContent;
                        // Add click listener only to the actual letter block
                        if (lockedBlock && lockedBlock.isRequired) {
                           cell.firstChild.addEventListener('click', handleGridBlockClick);
                        }
                    }

                    gameArea.appendChild(cell);
                }
            }
        }

        function checkCollision(x, y) {
            // Check boundaries
            if (x < 0 || x >= GRID_WIDTH || y < 0 || y >= GRID_HEIGHT) {
                return true; // Collision with wall/floor
            }
            // Check locked blocks
            if (lockedBlocks.some(b => b.x === x && b.y === y)) {
                return true; // Collision with another block
            }
            return false;
        }

        // NEW: Function to spawn a block (random or required)
        function spawnNewBlock() {
            const allRequiredSpawned = requiredLettersIndex >= currentWordLetters.length;
            
            let letter;
            let color;
            let isRequired;
            
            // Spawn a required letter if available AND random chance is met (e.g., 60%)
            // or if we haven't spawned the first two required letters yet (to ensure the word is possible)
            const spawnRequired = !allRequiredSpawned && (Math.random() < 0.6 || requiredLettersIndex < 2);

            if (spawnRequired) {
                letter = currentWordLetters[requiredLettersIndex];
                color = colors[requiredLettersIndex % colors.length]; // Color based on required index
                isRequired = true;
                requiredLettersIndex++;
            } else {
                // Spawn a distractor letter
                const randomIndex = Math.floor(Math.random() * distractorLetters.length);
                letter = distractorLetters[randomIndex];
                color = colors[Math.floor(Math.random() * colors.length)]; // Random vibrant color
                isRequired = false;
            }
            
            // Randomize starting column
            const startX = Math.floor(Math.random() * GRID_WIDTH);
            
            currentBlock = {
                letter: letter,
                x: startX,
                y: 0,
                color: color,
                isRequired: isRequired 
            };

            // Check for game over (spawn location already occupied)
            if (checkCollision(currentBlock.x, currentBlock.y)) {
                if (currentBlock.isRequired) {
                     // Game Over (required block couldn't spawn)
                    message.textContent = "KHÃ”NG GIAN ÄÃƒ Háº¾T. HoÃ n thÃ nh tá»«!";
                    message.style.color = "red";
                    checkBtnWordPuzzle.disabled = false;
                    currentBlock = null;
                    clearInterval(wordPuzzleInterval); // Stop game loop
                    drawGrid();
                    return null;
                } else {
                    // Distractor block collided immediately, skip it and try again
                    currentBlock = null;
                    return spawnNewBlock(); 
                }
            }

            drawGrid();
            return currentBlock;
        }


        function moveBlock(dx, dy) {
            if (!currentBlock) return;

            const newX = currentBlock.x + dx;
            const newY = currentBlock.y + dy;

            if (!checkCollision(newX, newY)) {
                currentBlock.x = newX;
                currentBlock.y = newY;
                drawGrid();
                return true;
            }
            return false;
        }

        function lockBlock() {
            if (!currentBlock) return;

            blockIdCounter++;
            lockedBlocks.push({
                id: blockIdCounter,
                letter: currentBlock.letter,
                x: currentBlock.x,
                y: currentBlock.y,
                color: currentBlock.color,
                isUsed: false,
                isRequired: currentBlock.isRequired // Persist the required status
            });
            
            currentBlock = null;
            checkLineClear();

            // Next block will be spawned by autoDrop on the next interval
        }

        function checkLineClear() {
            let linesCleared = 0;
            
            for (let y = GRID_HEIGHT - 1; y >= 0; y--) {
                // Check if the current row is full (contains GRID_WIDTH locked blocks)
                const rowBlocks = lockedBlocks.filter(b => b.y === y);
                if (rowBlocks.length === GRID_WIDTH) {
                    linesCleared++;
                    // Remove blocks from the cleared row
                    lockedBlocks = lockedBlocks.filter(b => b.y !== y);
                } else if (linesCleared > 0) {
                    // Shift blocks above the cleared lines down
                    lockedBlocks.forEach(b => {
                        if (b.y < y) {
                            b.y += linesCleared;
                        }
                    });
                }
            }
            
            if (linesCleared > 0) {
                successSound.play(); 
                message.textContent = `Tuyá»‡t vá»i! ÄÃ£ dá»n ${linesCleared} hÃ ng.`;
                message.style.color = 'green';
                drawGrid();
            }
        }

        function autoDrop() {
            if (!currentBlock) {
                // Try to spawn a new block every interval
                spawnNewBlock(); 
                drawGrid(); 
                return;
            }
            
            // Try to move down
            if (moveBlock(0, 1)) {
                // Still falling
                dropSound.play(); // Optional sound for movement
            } else {
                // Hit the bottom or another block
                lockBlock();
            }
            drawGrid();
        }

        // Drop Zone Interaction Logic 

        function handleGridBlockClick(event) {
            const clickedBlockElement = event.currentTarget;
            const blockId = parseInt(clickedBlockElement.getAttribute('data-id'));
            const block = lockedBlocks.find(b => b.id === blockId);

            // Check if the block is a required letter and not already used
            if (!block || !block.isRequired || block.isUsed || clickedBlockElement.getAttribute('data-used') === 'true') {
                 if (block && !block.isRequired) {
                    message.textContent = "Chá»‰ Ä‘Æ°á»£c chá»n nhá»¯ng chá»¯ cÃ¡i cáº§n thiáº¿t (mÃ u Ä‘áº­m)!";
                    message.style.color = "red";
                 }
                 return; 
            }

            const letter = block.letter;
            const dropSlots = Array.from(dropZone.children);
            let targetSlot = null;

            // Find the first empty slot
            for (const slot of dropSlots) {
                if (slot.textContent === "") {
                    targetSlot = slot;
                    break;
                }
            }

            if (targetSlot) {
                // Update slot
                targetSlot.textContent = letter;
                targetSlot.style.backgroundColor = block.color;
                targetSlot.style.color = '#fff';
                targetSlot.setAttribute('data-original-id', block.id);

                // Update block state in grid
                block.isUsed = true;
                // We let drawGrid handle the visual update of the clicked block
                
                message.textContent = '';
                resetBtn.style.display = 'inline-block';
                dropSound.play();
                drawGrid(); // Redraw grid to update visual state of the clicked block
            } else {
                message.textContent = "VÃ¹ng ghÃ©p chá»¯ Ä‘Ã£ Ä‘áº§y.";
                message.style.color = "orange";
            }
        }

        function handleDropSlotClear(event) {
            const clickedSlot = event.target;
            const originalTileId = parseInt(clickedSlot.getAttribute('data-original-id'));
            
            if (!originalTileId || clickedSlot.textContent === "") return;

            // Find the original locked block in the grid
            const originalBlock = lockedBlocks.find(b => b.id === originalTileId);
            
            if (originalBlock) {
                // Restore block state in grid
                originalBlock.isUsed = false;
            }
            
            // Clear slot
            clickedSlot.textContent = "";
            clickedSlot.style.backgroundColor = "";
            clickedSlot.style.color = "#333";
            clickedSlot.removeAttribute('data-original-id');
            message.textContent = '';
            
            // Hide reset button if no letters left
            const formedWord = Array.from(dropZone.children).map(slot => slot.textContent).join('');
            if (formedWord === '') {
                 resetBtn.style.display = 'none';
            }
            drawGrid(); // Redraw grid to update visual state of the restored block
        }

        // Input Handlers (Touch focused)
        function handleTouchStart(e) {
            if (!wordPuzzleInterval) return; // Ignore if game is stopped
            if (e.touches.length > 0) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }
        }

        function handleTouchMove(e) {
            if (!touchStartX || !currentBlock || e.touches.length === 0 || !wordPuzzleInterval) return;
            
            const touchEndX = e.touches[0].clientX;
            const touchEndY = e.touches[0].clientY;
            
            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;
            
            const threshold = 20;

            if (Math.abs(dx) > threshold && Math.abs(dx) > Math.abs(dy)) {
                // Horizontal swipe (move left/right)
                moveBlock(dx > 0 ? 1 : -1, 0);
                touchStartX = touchEndX; // Reset starting position for continuous movement
                e.preventDefault();
            } else if (dy > threshold * 2 && dy > Math.abs(dx)) { 
                // Vertical swipe (fast drop)
                while(moveBlock(0, 1));
                lockBlock();
                touchStartX = 0; // Disable further checks until next touch start
                e.preventDefault();
            }
        }
        
        // The main initialization function
        function initWordPuzzleTetris() {
            // Clear previous game state
            clearInterval(wordPuzzleInterval); 
            currentBlock = null;
            lockedBlocks = [];
            blockIdCounter = 0;
            requiredLettersIndex = 0; // Reset index for tracking

            // Filter and select a word
            const validWords = vocabularyData[currentUnit].filter(item => item.word.length >= 4 && item.word.length <= GRID_WIDTH);
            if (validWords.length === 0) {
                message.textContent = "KhÃ´ng cÃ³ tá»« vá»±ng há»£p lá»‡ (4-10 chá»¯ cÃ¡i) trong Unit nÃ y.";
                message.style.color = "orange";
                info.textContent = "";
                dropZone.innerHTML = "";
                gameArea.innerHTML = "";
                checkBtnWordPuzzle.disabled = true;
                return;
            }

            currentWordPuzzle = validWords[Math.floor(Math.random() * validWords.length)];
            currentWordLetters = currentWordPuzzle.word.toUpperCase().split(''); 

            info.textContent = `NghÄ©a: ${currentWordPuzzle.definition} (${currentWordLetters.length} chá»¯ cÃ¡i)`;
            message.textContent = "Xáº¿p cÃ¡c khá»‘i chá»¯ Ä‘á»ƒ táº¡o tá»«!";
            message.style.color = "blue";
            checkBtnWordPuzzle.disabled = true;
            resetBtn.style.display = 'none';

            // 1. Setup Drop Zone
            dropZone.innerHTML = '';
            for (let i = 0; i < currentWordLetters.length; i++) {
                const dropSlot = document.createElement("div");
                dropSlot.className = "dropSlot-word-puzzle";
                dropSlot.setAttribute('data-index', i);
                dropSlot.addEventListener('click', handleDropSlotClear); 
                dropZone.appendChild(dropSlot);
            }
            
            // 2. Setup Game Grid
            drawGrid(); // Initial empty draw

            // 3. Start Game Loop
            spawnNewBlock(); // Spawn the first block
            wordPuzzleInterval = setInterval(autoDrop, DROP_INTERVAL);
            
            // 4. Attach Touch Listeners to the game area
            gameArea.removeEventListener('touchstart', handleTouchStart);
            gameArea.removeEventListener('touchmove', handleTouchMove);
            gameArea.addEventListener('touchstart', handleTouchStart);
            gameArea.addEventListener('touchmove', handleTouchMove, { passive: false }); 
        }

        // HÃ€M Xá»¬ LÃ NÃšT KIá»‚M TRA
        checkBtnWordPuzzle.addEventListener("click",()=>{
            const formedWord=Array.from(dropZone.children).map(slot=>slot.textContent.toLowerCase()).join('');
            if(formedWord.length !== currentWordPuzzle.word.length) {
                message.textContent="Báº¡n chÆ°a xáº¿p Ä‘á»§ sá»‘ chá»¯ cÃ¡i!";
                message.style.color="orange";
                return;
            }
            if(formedWord===currentWordPuzzle.word.toLowerCase()){
                message.textContent="ChÃ­nh xÃ¡c! ğŸ‰";
                message.style.color="green";
                successSound.play(); 
                checkBtnWordPuzzle.disabled = true;
                resetBtn.style.display = "none";
                clearInterval(wordPuzzleInterval); // Stop game loop
                // Mark all required blocks as used (dim them)
                lockedBlocks.forEach(block => {
                    if (block.isRequired && !block.isUsed) block.isUsed = true;
                });
                drawGrid();
                setTimeout(initWordPuzzleTetris, 3000); // ChÆ¡i tá»« tiáº¿p theo
            } else {
                message.textContent="Sai rá»“i, thá»­ láº¡i! âŒ";
                message.style.color="red";
                // Cho phÃ©p reset khu vá»±c xáº¿p chá»¯
                resetBtn.style.display="inline-block";
            }
        });

        // HÃ€M Xá»¬ LÃ NÃšT RESET
        resetBtn.addEventListener("click", () => {
            // Dá»n sáº¡ch cÃ¡c Ã´ Ä‘Ã£ ghÃ©p
            Array.from(dropZone.children).forEach(slot => {
                const originalId = parseInt(slot.getAttribute('data-original-id'));
                if (originalId) {
                    const originalBlock = lockedBlocks.find(b => b.id === originalId);
                    if (originalBlock) {
                        originalBlock.isUsed = false;
                    }
                    slot.textContent = "";
                    slot.style.backgroundColor = "";
                    slot.style.color = "#333";
                    slot.removeAttribute('data-original-id');
                }
            });
            message.textContent = "";
            resetBtn.style.display = "none";
            drawGrid();
        });
        // END: Logic cho BÃ i Xáº¿p Chá»¯


        // GÃ¡n sá»± kiá»‡n cho cÃ¡c nÃºt Unit
        unitButtons.forEach(button => {
            button.addEventListener('click', () => {
                selectUnit(button.dataset.unit);
            });
        });

        // GÃ¡n sá»± kiá»‡n cho cÃ¡c nÃºt Tab
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // GÃ¡n sá»± kiá»‡n cho cÃ¡c nÃºt Sub-Tab
        document.querySelectorAll('.practice-sub-tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchPracticeSubTab(button.dataset.practiceTab);
            });
        });

        // Khá»Ÿi cháº¡y game khi táº£i trang
        window.onload = () => {
            // Chá»n Unit 1 vÃ  Tab Flashcard khi táº£i trang
            selectUnit('unit-1');
            switchTab('flashcard');
        }
    </script>
</body>
</html>