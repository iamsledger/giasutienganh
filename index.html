<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·ªï Tay & Quiz T·ª´ V·ª±ng Ti·∫øng Anh 10 Global Success</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- C√†i ƒë·∫∑t font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Load Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Font v√† m√†u s·∫Øc c∆° b·∫£n */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Light background */
            color: #1f2937; /* Gray-800 */
        }
        /* Style cho n√∫t Unit ƒëang ho·∫°t ƒë·ªông */
        .unit-button.active {
            background-color: #10b981; /* Emerald-500 */
            color: #FFFFFF;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.5), 0 2px 4px -1px rgba(16, 185, 129, 0.06);
        }
        .tab-button.active {
            border-bottom: 3px solid #f97316; /* Orange-500 */
            color: #f97316;
            font-weight: 700;
        }
        /* Style cho th·∫ª t·ª´ v·ª±ng */
        .vocab-card {
            background-color: #ffffff;
            border-left: 5px solid #3b82f6; /* Blue-500 */
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .vocab-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style cho quiz */
        .quiz-card {
            background-color: #ffffff;
            transition: all 0.2s;
            cursor: pointer;
        }
        .quiz-card:hover {
            background-color: #e5e7eb; /* Gray-200 */
        }
        .quiz-card.correct {
            background-color: #d1fae5; /* Green-100 */
            border: 2px solid #10b981; /* Emerald-500 */
            transform: scale(1.05);
        }
        .quiz-card.incorrect {
            background-color: #fee2e2; /* Red-100 */
            border: 2px solid #ef4444; /* Red-500 */
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            20%, 60% {transform: translateX(-5px);}
            40%, 80% {transform: translateX(5px);}
        }
        .timer-bar {
            height: 8px;
            background-color: #3b82f6;
            transition: width 0.1s linear;
        }

        /* --- STYLES CHO MINIGAME WORD PUZZLE TETRIS --- */
        #gameArea {
            width: 400px;
            height: 500px; /* TƒÉng chi·ªÅu cao */
            border: 3px solid #333;
            background: #e6f7ff;
            position: relative;
            overflow: hidden;
            margin: 20px auto 10px;
        }
        .letter {
            width: 50px; height: 50px;
            border: 2px solid #333;
            border-radius: 5px;
            text-align: center;
            line-height: 50px;
            font-size: 24px;
            font-weight: bold;
            position: absolute;
            cursor: grab;
            color: #fff;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }
        #dropZoneGame {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            min-height: 60px;
        }
        .dropSlotGame {
            width: 50px;
            height: 50px;
            margin: 0 5px;
            border: 2px dashed #3b82f6;
            border-radius: 5px;
            text-align: center;
            line-height: 50px;
            font-size: 24px;
            font-weight: bold;
            background: #ffffff;
            color: #1f2937;
        }
        /* --- END MINIGAME STYLES --- */

        /* Style cho Matching Game */
        .match-card {
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.1s ease;
            font-weight: 600;
        }
        .match-card.word { background-color: #bfdbfe; /* Blue-200 */ }
        .match-card.meaning { background-color: #d1fae5; /* Green-100 */ }
        .match-card.selected {
            border: 3px solid #f59e0b; /* Amber-500 */
            box-shadow: 0 0 10px #f59e0b;
            transform: scale(1.02);
        }
        .match-card.matched {
            background-color: #10b981; /* Emerald-500 */
            color: white;
            cursor: default;
            pointer-events: none;
            opacity: 0.8;
            transform: scale(1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-orange-600">S·ªï Tay & Quiz T·ª´ V·ª±ng</h1>
            <p class="text-xl text-gray-600 mt-2">Ti·∫øng Anh 10 - Global Success</p>
        </header>

        <!-- Unit Selection -->
        <div id="unit-selection" class="flex flex-wrap justify-center gap-2 mb-8 p-3 bg-gray-100 rounded-lg">
            <button class="unit-button bg-blue-500 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200" data-unit="unit-1">Unit 1</button>
            <button class="unit-button bg-blue-500 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200" data-unit="unit-2">Unit 2</button>
            <button class="unit-button bg-blue-500 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200" data-unit="unit-3">Unit 3</button>
            <button class="unit-button bg-blue-500 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200" data-unit="unit-4">Unit 4</button>
            <!-- Th√™m c√°c Unit kh√°c t·∫°i ƒë√¢y -->
        </div>

        <!-- Main Tabs -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-4 justify-center">
                <button class="tab-button py-2 px-4 text-gray-500 hover:text-orange-500 transition-colors duration-200 active" data-section="vocab-section">
                    <i class="fas fa-book mr-2"></i>S·ªï Tay T·ª´ V·ª±ng
                </button>
                <button class="tab-button py-2 px-4 text-gray-500 hover:text-orange-500 transition-colors duration-200" data-section="quiz-section">
                    <i class="fas fa-brain mr-2"></i>Luy·ªán T·∫≠p
                </button>
                <button class="tab-button py-2 px-4 text-gray-500 hover:text-orange-500 transition-colors duration-200" data-section="results-section">
                    <i class="fas fa-poll-h mr-2"></i>K·∫øt Qu·∫£
                </button>
            </nav>
        </div>

        <!-- S·ªï Tay T·ª´ V·ª±ng -->
        <section id="vocab-section" class="main-section">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">T·ª´ V·ª±ng Unit: <span id="current-unit-title" class="text-emerald-600"></span></h2>
            <div id="vocab-list" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                <!-- Th·∫ª t·ª´ v·ª±ng s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y -->
            </div>
            <p id="no-vocab-message" class="text-center text-gray-500 mt-8 hidden">Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ v·ª±ng cho Unit n√†y.</p>
        </section>

        <!-- Luy·ªán T·∫≠p (Quiz) -->
        <section id="quiz-section" class="main-section hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Ch·ªçn B√†i T·∫≠p Luy·ªán T·∫≠p</h2>
            <div class="flex flex-wrap gap-3 mb-6">
                <button class="quiz-type-button bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105" data-quiz="writing">
                    <i class="fas fa-keyboard mr-2"></i>Vi·∫øt T·ª´
                </button>
                <button class="quiz-type-button bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105" data-quiz="multiple-choice">
                    <i class="fas fa-list-ul mr-2"></i>Ch·ªçn ƒê√°p √Ån
                </button>
                <button class="quiz-type-button bg-pink-500 text-white font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105" data-quiz="listening">
                    <i class="fas fa-volume-up mr-2"></i>Nghe & Ch·ªçn
                </button>
                <button class="quiz-type-button bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105" data-quiz="matching">
                    <i class="fas fa-link mr-2"></i>Gh√©p T·ª´ v·ªõi Nghƒ©a
                </button>
                <button class="quiz-type-button bg-red-500 text-white font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105" data-quiz="minigame">
                    <i class="fas fa-gamepad mr-2"></i>Minigame Word Tetris
                </button>
            </div>

            <!-- Giao di·ªán chung cho Quiz (Writing, Multiple Choice) -->
            <div id="active-quiz-section" class="hidden bg-gray-50 p-6 rounded-xl shadow-inner">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-lg font-medium text-gray-600"><span id="current-quiz-title" class="text-blue-600 font-bold"></span></p>
                    <p class="text-xl font-bold text-orange-600"><span id="current-question-index">1</span> / <span id="total-questions">10</span></p>
                </div>

                <!-- Timer -->
                <div class="w-full bg-gray-200 rounded-full mb-6">
                    <div id="timer-bar" class="timer-bar rounded-full" style="width: 100%;"></div>
                </div>

                <!-- V√πng hi·ªÉn th·ªã c√¢u h·ªèi -->
                <div id="quiz-content">
                    <!-- Quiz: Writing -->
                    <div id="writing-quiz-ui" class="text-center hidden">
                        <p class="text-2xl font-semibold mb-4 text-gray-800">Nghƒ©a ti·∫øng Vi·ªát:</p>
                        <p id="writing-meaning" class="text-3xl font-extrabold text-indigo-700 mb-6"></p>
                        <input type="text" id="writing-input" placeholder="Nh·∫≠p t·ª´ ti·∫øng Anh..." class="w-full max-w-sm p-3 border-2 border-gray-300 rounded-lg text-center text-xl focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all">
                        <p id="writing-feedback" class="mt-4 text-xl font-bold min-h-[30px]"></p>
                    </div>

                    <!-- Quiz: Multiple Choice -->
                    <div id="multiple-choice-quiz-ui" class="hidden">
                        <p class="text-2xl font-semibold mb-4 text-gray-800">Ch·ªçn nghƒ©a ƒë√∫ng c·ªßa t·ª´:</p>
                        <p id="mc-word" class="text-3xl font-extrabold text-indigo-700 mb-6 text-center"></p>
                        <div id="mc-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- C√°c l·ª±a ch·ªçn s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y -->
                        </div>
                    </div>

                    <!-- Quiz: Matching (Gh√©p t·ª´) -->
                    <div id="matching-quiz-ui" class="hidden">
                        <p class="text-2xl font-semibold mb-6 text-gray-800 text-center">Gh√©p T·ª´ v·ªõi Nghƒ©a t∆∞∆°ng ·ª©ng</p>
                        <div class="grid grid-cols-2 gap-4 max-w-lg mx-auto">
                            <div id="matching-words-column" class="flex flex-col gap-2">
                                <h3 class="text-xl font-bold text-blue-600 border-b-2 pb-1 mb-2">T·ª´ ti·∫øng Anh</h3>
                                <!-- Cards Word -->
                            </div>
                            <div id="matching-meanings-column" class="flex flex-col gap-2">
                                <h3 class="text-xl font-bold text-emerald-600 border-b-2 pb-1 mb-2">Nghƒ©a ti·∫øng Vi·ªát</h3>
                                <!-- Cards Meaning -->
                            </div>
                        </div>
                        <p id="matching-feedback" class="mt-4 text-xl font-bold text-center min-h-[30px]"></p>
                    </div>

                </div>

                <!-- N√∫t Next Question chung -->
                <div class="text-center mt-6">
                    <button id="next-question" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-xl transition-transform transform hover:scale-105 shadow-md hidden">
                        C√¢u Ti·∫øp Theo <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Quiz: Listening (Nghe v√† Ch·ªçn) -->
            <div id="listening-game-ui" class="hidden bg-gray-50 p-6 rounded-xl shadow-inner text-center">
                <p class="text-2xl font-semibold mb-6 text-gray-800">B·∫•m n√∫t Nghe v√† Ch·ªçn t·ª´ ƒë√∫ng:</p>
                <div class="flex justify-center items-center mb-8">
                    <button id="listening-play-button" class="bg-blue-600 hover:bg-blue-700 text-white w-16 h-16 rounded-full text-2xl transition-transform transform hover:scale-110">
                        <i class="fas fa-play"></i>
                    </button>
                    <span id="listening-word" class="ml-4 text-3xl font-extrabold text-indigo-700"></span>
                </div>
                <div id="listening-options" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-xl mx-auto">
                    <!-- C√°c th·∫ª l·ª±a ch·ªçn s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y -->
                </div>
            </div>

            <!-- Minigame Word Puzzle Tetris -->
            <div id="minigame-ui" class="hidden bg-gray-50 p-6 rounded-xl shadow-inner text-center">
                <h3 class="text-2xl font-bold text-orange-600 mb-4">Word Puzzle Tetris</h3>
                <p class="text-gray-600 mb-4">K√©o th·∫£ c√°c ch·ªØ c√°i r∆°i v√†o √¥ tr·ªëng b√™n d∆∞·ªõi ƒë·ªÉ t·∫°o th√†nh t·ª´ c√≥ nghƒ©a t∆∞∆°ng ·ª©ng.</p>

                <div id="gameArea" class="mx-auto"></div>
                <div id="dropZoneGame" class="mx-auto"></div>
                <div id="info" class="font-bold text-xl text-indigo-700 mt-4"></div>
                <button id="checkBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg transition-transform hover:scale-105 mt-4 mr-2">
                    Ki·ªÉm tra t·ª´
                </button>
                <button id="resetBtnGame" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition-transform hover:scale-105 mt-4" style="display:none;">
                    Reset t·ª´ gh√©p
                </button>
                <div id="messageGame" class="mt-4 text-xl font-bold min-h-[30px]"></div>

                <!-- Audio cho game -->
                <audio id="dropSound" src="https://actions.google.com/sounds/v1/foley/wood_fall.ogg"></audio>
                <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
            </div>


        </section>

        <!-- K·∫øt Qu·∫£ -->
        <section id="results-section" class="main-section hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">K·∫øt Qu·∫£ Luy·ªán T·∫≠p</h2>
            <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-orange-500">
                <p class="text-xl mb-4"><span id="result-unit" class="font-bold text-emerald-600"></span> - B√†i t·∫≠p: <span id="result-type" class="font-bold text-blue-600"></span></p>
                <p class="text-5xl font-extrabold text-center text-gray-800 mb-4"><span id="correct-count">0</span> / <span id="total-count">0</span></p>
                <div id="result-message" class="text-center text-2xl font-bold text-orange-500">Tuy·ªát v·ªùi!</div>
            </div>
        </section>

    </div>

    <!-- Firebase App/Auth/Firestore Import (Placeholder for environment setup) -->
    <script type="module">
        // Bi·∫øn m√¥i tr∆∞·ªùng
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        // N·∫øu m√¥i tr∆∞·ªùng Firebase kh·∫£ d·ª•ng (ch·ªâ ƒë·ªãnh c·∫•u h√¨nh), th·ª±c hi·ªán kh·ªüi t·∫°o
        if (firebaseConfig) {
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            const initFirebase = async () => {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // B·∫≠t log debug cho Firestore
                    setLogLevel('debug');

                    // ƒêƒÉng nh·∫≠p b·∫±ng token t√πy ch·ªânh ho·∫∑c ·∫©n danh
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    console.log("Firebase initialized and signed in.");

                    // L·∫Øng nghe tr·∫°ng th√°i Auth
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            window.userId = user.uid;
                            console.log("User ID:", window.userId);
                            // C√≥ th·ªÉ t·∫£i d·ªØ li·ªáu c√° nh√¢n ·ªü ƒë√¢y n·∫øu c·∫ßn
                        } else {
                            window.userId = crypto.randomUUID(); // D√πng ID ng·∫´u nhi√™n n·∫øu ·∫©n danh/ch∆∞a ƒëƒÉng nh·∫≠p
                            console.log("Signed out or anonymous. Generated random ID:", window.userId);
                        }
                    });

                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    // Fallback to random ID if Firebase fails
                    window.userId = crypto.randomUUID();
                }
            };
            initFirebase();
        } else {
            // Kh√¥ng c√≥ Firebase, d√πng ID ng·∫´u nhi√™n
            window.userId = crypto.randomUUID();
            console.log("Firebase config not found. Using random ID:", window.userId);
        }
    </script>

    <script>
        // --- DATA T·ª™ V·ª∞NG TI·∫æNG ANH 10 GLOBAL SUCCESS (KNTT) ---
        const vocabData = {
            'unit-1': [
                { word: 'nuclear family', meaning: 'gia ƒë√¨nh h·∫°t nh√¢n', type: 'n' },
                { word: 'extended family', meaning: 'ƒë·∫°i gia ƒë√¨nh', type: 'n' },
                { word: 'breadwinner', meaning: 'ng∆∞·ªùi tr·ª• c·ªôt (ki·∫øm ti·ªÅn)', type: 'n' },
                { word: 'household chores', meaning: 'vi·ªác nh√†', type: 'n' },
                { word: 'laundry', meaning: 'qu·∫ßn √°o b·∫©n/vi·ªác gi·∫∑t ·ªßi', type: 'n' },
                { word: 'do the washing up', meaning: 'r·ª≠a b√°t ƒëƒ©a', type: 'v phr' },
                { word: 'groceries', meaning: 'th·ª±c ph·∫©m v√† nhu y·∫øu ph·∫©m', type: 'n' },
                { word: 'vulnerable', meaning: 'd·ªÖ b·ªã t·ªïn th∆∞∆°ng', type: 'adj' },
                { word: 'caring', meaning: 'chu ƒë√°o, quan t√¢m', type: 'adj' },
                { word: 'supportive', meaning: 'h·ªó tr·ª£, ·ªßng h·ªô', type: 'adj' },
            ],
            'unit-2': [
                { word: 'obesity', meaning: 'b·ªánh b√©o ph√¨', type: 'n' },
                { word: 'nutrition', meaning: 'dinh d∆∞·ª°ng', type: 'n' },
                { word: 'lifestyle', meaning: 'l·ªëi s·ªëng', type: 'n' },
                { word: 'allergy', meaning: 'd·ªã ·ª©ng', type: 'n' },
                { word: 'stressed', meaning: 'b·ªã cƒÉng th·∫≥ng', type: 'adj' },
                { word: 'balanced diet', meaning: 'ch·∫ø ƒë·ªô ƒÉn c√¢n b·∫±ng', type: 'n phr' },
                { word: 'junk food', meaning: 'ƒë·ªì ƒÉn v·∫∑t', type: 'n phr' },
                { word: 'well-being', meaning: 's·ª± kh·ªèe m·∫°nh, h·∫°nh ph√∫c', type: 'n' },
            ],
            'unit-3': [
                { word: 'painting', meaning: 'h·ªôi h·ªça/b·ª©c tranh', type: 'n' },
                { word: 'sculpture', meaning: 'ƒëi√™u kh·∫Øc/t√°c ph·∫©m ƒëi√™u kh·∫Øc', type: 'n' },
                { word: 'masterpiece', meaning: 'ki·ªát t√°c', type: 'n' },
                { word: 'composer', meaning: 'nh√† so·∫°n nh·∫°c', type: 'n' },
                { word: 'exhibition', meaning: 'tri·ªÉn l√£m', type: 'n' },
                { word: 'abstract', meaning: 'tr·ª´u t∆∞·ª£ng', type: 'adj' },
                { word: 'portrait', meaning: 'tranh ch√¢n dung', type: 'n' },
                { word: 'venue', meaning: 'ƒë·ªãa ƒëi·ªÉm t·ªï ch·ª©c', type: 'n' },
            ],
            'unit-4': [
                { word: 'earthquake', meaning: 'ƒë·ªông ƒë·∫•t', type: 'n' },
                { word: 'volcano', meaning: 'n√∫i l·ª≠a', type: 'n' },
                { word: 'eruption', meaning: 's·ª± phun tr√†o', type: 'n' },
                { word: 'typhoon', meaning: 'b√£o nhi·ªát ƒë·ªõi', type: 'n' },
                { word: 'tsunami', meaning: 's√≥ng th·∫ßn', type: 'n' },
                { word: 'disaster', meaning: 'th·∫£m h·ªça', type: 'n' },
                { word: 'evacuation', meaning: 's·ª± s∆° t√°n', type: 'n' },
                { word: 'aftershock', meaning: 'd∆∞ ch·∫•n', type: 'n' },
            ]
        };

        let currentUnit = 'unit-1';
        let currentQuizType = 'writing';
        let currentQuizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        const MAX_ROUNDS = 10; // S·ªë c√¢u h·ªèi t·ªëi ƒëa
        const TIME_PER_QUESTION = 15; // 15 gi√¢y

        // --- H√ÄM CHUNG ---

        function showSection(sectionId) {
            document.querySelectorAll('.main-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-section="${sectionId}"]`).classList.add('active');

            if (sectionId !== 'quiz-section') {
                // ƒê·∫£m b·∫£o kh√¥ng c√≥ quiz n√†o ƒëang ch·∫°y khi chuy·ªÉn tab
                document.getElementById('active-quiz-section').classList.add('hidden');
                document.getElementById('listening-game-ui').classList.add('hidden');
                document.getElementById('minigame-ui').classList.add('hidden');
            }
        }

        function selectUnit(unitId) {
            currentUnit = unitId;
            document.getElementById('current-unit-title').textContent = unitId.replace('unit-', 'Unit ');

            document.querySelectorAll('.unit-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.unit-button[data-unit="${unitId}"]`).classList.add('active');

            displayVocab(unitId);
        }

        function displayVocab(unitId) {
            const list = document.getElementById('vocab-list');
            list.innerHTML = '';
            const words = vocabData[unitId];

            if (!words || words.length === 0) {
                document.getElementById('no-vocab-message').classList.remove('hidden');
                return;
            }
            document.getElementById('no-vocab-message').classList.add('hidden');

            words.forEach(item => {
                const card = document.createElement('div');
                card.className = 'vocab-card p-4 rounded-xl shadow-md';
                card.innerHTML = `
                    <p class="text-xl font-bold text-gray-900">${item.word}</p>
                    <p class="text-sm font-medium text-blue-500 mb-1">(${item.type})</p>
                    <p class="text-gray-600">${item.meaning}</p>
                `;
                list.appendChild(card);
            });
        }

        function startQuiz(quizType) {
            currentQuizType = quizType;
            score = 0;
            currentQuestionIndex = 0;
            const unitWords = vocabData[currentUnit];

            if (!unitWords || unitWords.length < 5) {
                alert("Kh√¥ng ƒë·ªß t·ª´ v·ª±ng ƒë·ªÉ t·∫°o b√†i quiz (c·∫ßn √≠t nh·∫•t 5 t·ª´).");
                return;
            }

            // Ch·ªçn ng·∫´u nhi√™n t·ªëi ƒëa MAX_ROUNDS t·ª´ cho quiz
            currentQuizData = shuffleArray([...unitWords]).slice(0, MAX_ROUNDS);

            // ·∫®n t·∫•t c·∫£ quiz UI v√† hi·ªÉn th·ªã UI chung
            document.getElementById('writing-quiz-ui').classList.add('hidden');
            document.getElementById('multiple-choice-quiz-ui').classList.add('hidden');
            document.getElementById('listening-game-ui').classList.add('hidden');
            document.getElementById('matching-quiz-ui').classList.add('hidden');
            document.getElementById('minigame-ui').classList.add('hidden');
            document.getElementById('next-question').classList.add('hidden');
            document.getElementById('writing-feedback').textContent = '';
            document.getElementById('matching-feedback').textContent = '';

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ quiz
            let title = '';
            let activeQuizId = 'active-quiz-section';

            if (quizType === 'writing') {
                title = 'Vi·∫øt T·ª´';
                document.getElementById('writing-quiz-ui').classList.remove('hidden');
            } else if (quizType === 'multiple-choice') {
                title = 'Ch·ªçn ƒê√°p √Ån';
                document.getElementById('multiple-choice-quiz-ui').classList.remove('hidden');
            } else if (quizType === 'listening') {
                title = 'Nghe & Ch·ªçn';
                activeQuizId = 'listening-game-ui';
                startListeningGame();
            } else if (quizType === 'matching') {
                title = 'Gh√©p T·ª´ v·ªõi Nghƒ©a';
                document.getElementById('matching-quiz-ui').classList.remove('hidden');
                startMatchingGame();
            } else if (quizType === 'minigame') {
                title = 'Minigame Word Tetris';
                activeQuizId = 'minigame-ui';
                document.getElementById('minigame-ui').classList.remove('hidden');
                startGameTetris(); // Kh·ªüi ƒë·ªông minigame
            }

            document.getElementById('current-quiz-title').textContent = title;
            document.getElementById('active-quiz-section').classList.remove('hidden');

            if (quizType !== 'listening' && quizType !== 'matching' && quizType !== 'minigame') {
                document.getElementById(activeQuizId).classList.remove('hidden');
                document.getElementById('total-questions').textContent = currentQuizData.length;
                nextQuestion();
            } else if (quizType === 'minigame') {
                document.getElementById('active-quiz-section').classList.add('hidden');
                document.getElementById('minigame-ui').classList.remove('hidden');
            } else if (quizType === 'matching') {
                 document.getElementById('active-quiz-section').classList.remove('hidden');
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            let timeLeft = TIME_PER_QUESTION;
            const timerBar = document.getElementById('timer-bar');
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#3b82f6';

            timerInterval = setInterval(() => {
                timeLeft -= 0.1; // Gi·∫£m 0.1 gi√¢y ƒë·ªÉ t·∫°o chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† h∆°n
                const percentage = (timeLeft / TIME_PER_QUESTION) * 100;
                timerBar.style.width = percentage + '%';

                if (percentage < 30) {
                    timerBar.style.backgroundColor = '#ef4444'; // ƒê·ªè khi g·∫ßn h·∫øt gi·ªù
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 100);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function handleTimeout() {
            if (currentQuizType === 'writing') {
                const correctWord = currentQuizData[currentQuestionIndex - 1].word;
                document.getElementById('writing-feedback').textContent = `H·∫øt gi·ªù! ƒê√°p √°n ƒë√∫ng l√†: ${correctWord}`;
                document.getElementById('writing-feedback').style.color = 'orange';
                document.getElementById('next-question').classList.remove('hidden');
                document.getElementById('writing-input').disabled = true;
            } else if (currentQuizType === 'multiple-choice') {
                revealCorrectAnswer();
                document.getElementById('next-question').classList.remove('hidden');
            }
        }

        function nextQuestion() {
            stopTimer();

            if (currentQuestionIndex >= currentQuizData.length) {
                endQuiz();
                return;
            }

            document.getElementById('current-question-index').textContent = currentQuestionIndex + 1;
            document.getElementById('next-question').classList.add('hidden');

            if (currentQuizType === 'writing') {
                loadWritingQuestion(currentQuizData[currentQuestionIndex]);
            } else if (currentQuizType === 'multiple-choice') {
                loadMultipleChoiceQuestion(currentQuizData[currentQuestionIndex]);
            }

            currentQuestionIndex++;
            startTimer();
        }

        function endQuiz() {
            document.getElementById('active-quiz-section').classList.add('hidden');
            displayResults(score, currentQuizData.length);
            showSection('results-section');
        }

        function displayResults(correctCount, totalCount) {
            document.getElementById('result-unit').textContent = currentUnit.replace('unit-', 'Unit ');
            document.getElementById('result-type').textContent = document.getElementById('current-quiz-title').textContent;
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('total-count').textContent = totalCount;

            const messageEl = document.getElementById('result-message');
            const percentage = (correctCount / totalCount) * 100;

            if (percentage === 100) {
                messageEl.textContent = 'Ho√†n h·∫£o! üéâ';
                messageEl.style.color = '#10b981'; // Emerald
            } else if (percentage >= 70) {
                messageEl.textContent = 'R·∫•t t·ªët! C·ªë g·∫Øng th√™m ch√∫t n·ªØa.';
                messageEl.style.color = '#f59e0b'; // Amber
            } else {
                messageEl.textContent = 'Ti·∫øp t·ª•c luy·ªán t·∫≠p nh√©!';
                messageEl.style.color = '#ef4444'; // Red
            }
        }

        // --- H√ÄM H·ªñ TR·ª¢ ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getOppositeWords(correctWord) {
            const allWords = Object.values(vocabData).flat();
            const wrongWords = allWords.filter(item => item.word !== correctWord).map(item => item.meaning);
            return shuffleArray(wrongWords).slice(0, 3);
        }

        // --- QUIZ TYPE LOGIC ---

        // 1. Logic Vi·∫øt T·ª´
        function loadWritingQuestion(data) {
            document.getElementById('writing-meaning').textContent = data.meaning;
            const inputEl = document.getElementById('writing-input');
            inputEl.value = '';
            inputEl.disabled = false;
            document.getElementById('writing-feedback').textContent = '';
            inputEl.focus();

            inputEl.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    checkWritingAnswer(data.word);
                }
            };
        }

        function checkWritingAnswer(correctWord) {
            stopTimer();
            const inputEl = document.getElementById('writing-input');
            const feedbackEl = document.getElementById('writing-feedback');
            const userAnswer = inputEl.value.trim().toLowerCase();

            inputEl.disabled = true;

            if (userAnswer === correctWord.toLowerCase()) {
                feedbackEl.textContent = 'Ch√≠nh x√°c! üéâ';
                feedbackEl.style.color = 'green';
                score++;
            } else {
                feedbackEl.textContent = `Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√†: ${correctWord}`;
                feedbackEl.style.color = 'red';
            }

            document.getElementById('next-question').classList.remove('hidden');
        }

        // 2. Logic Ch·ªçn ƒê√°p √Ån
        function loadMultipleChoiceQuestion(data) {
            const word = data.word;
            const meaning = data.meaning;
            document.getElementById('mc-word').textContent = word;

            const optionsContainer = document.getElementById('mc-options');
            optionsContainer.innerHTML = '';
            optionsContainer.dataset.correct = meaning; // L∆∞u ƒë√°p √°n ƒë√∫ng

            // T·∫°o 3 ƒë√°p √°n sai
            const allMeanings = vocabData[currentUnit].map(item => item.meaning);
            const wrongMeanings = allMeanings.filter(m => m !== meaning);
            const shuffledWrong = shuffleArray(wrongMeanings).slice(0, 3);

            // G·ªôp ƒë√°p √°n ƒë√∫ng v√† sai
            const options = shuffleArray([meaning, ...shuffledWrong]);

            options.forEach(option => {
                const card = document.createElement('div');
                card.className = 'quiz-card p-4 border rounded-xl text-center shadow-sm hover:shadow-md';
                card.textContent = option;
                card.onclick = () => checkMultipleChoiceAnswer(card, option, meaning);
                optionsContainer.appendChild(card);
            });
        }

        function checkMultipleChoiceAnswer(card, selectedOption, correctMeaning) {
            stopTimer();
            const optionsContainer = document.getElementById('mc-options');
            Array.from(optionsContainer.children).forEach(opt => opt.onclick = null); // V√¥ hi·ªáu h√≥a click

            if (selectedOption === correctMeaning) {
                card.classList.add('correct');
                score++;
            } else {
                card.classList.add('incorrect');
                // Highlight ƒë√°p √°n ƒë√∫ng
                revealCorrectAnswer();
            }

            document.getElementById('next-question').classList.remove('hidden');
        }

        function revealCorrectAnswer() {
            const correctMeaning = document.getElementById('mc-options').dataset.correct;
            Array.from(document.getElementById('mc-options').children).forEach(card => {
                if (card.textContent === correctMeaning) {
                    card.classList.add('correct');
                }
            });
        }

        // 3. Logic Gh√©p T·ª´ (Matching)
        let selectedWordCard = null;
        let selectedMeaningCard = null;
        let matchedCount = 0;

        function startMatchingGame() {
            matchedCount = 0;
            document.getElementById('matching-feedback').textContent = '';
            document.getElementById('active-quiz-section').classList.remove('hidden');
            document.getElementById('total-questions').textContent = currentQuizData.length;
            
            const wordsColumn = document.getElementById('matching-words-column');
            const meaningsColumn = document.getElementById('matching-meanings-column');
            wordsColumn.innerHTML = '<h3 class="text-xl font-bold text-blue-600 border-b-2 pb-1 mb-2">T·ª´ ti·∫øng Anh</h3>';
            meaningsColumn.innerHTML = '<h3 class="text-xl font-bold text-emerald-600 border-b-2 pb-1 mb-2">Nghƒ©a ti·∫øng Vi·ªát</h3>';
            
            // X√°o tr·ªôn v√† l·∫•y d·ªØ li·ªáu
            const wordsToMatch = shuffleArray([...currentQuizData]);
            const meaningsToMatch = shuffleArray([...wordsToMatch.map(item => ({ word: item.word, meaning: item.meaning }))]);

            wordsToMatch.forEach(item => {
                const card = createMatchCard(item.word, 'word', item.word);
                wordsColumn.appendChild(card);
            });

            meaningsToMatch.forEach(item => {
                const card = createMatchCard(item.meaning, 'meaning', item.word);
                meaningsColumn.appendChild(card);
            });
        }

        function createMatchCard(text, type, dataValue) {
            const card = document.createElement('div');
            card.className = `match-card ${type} p-3 rounded-lg shadow-sm`;
            card.textContent = text;
            card.dataset.match = dataValue; // L∆∞u t·ª´ ti·∫øng Anh l√†m kh√≥a gh√©p
            card.dataset.type = type;
            card.onclick = () => handleMatchClick(card);
            return card;
        }

        function handleMatchClick(card) {
            if (card.classList.contains('matched')) return;

            const type = card.dataset.type;
            
            if (type === 'word') {
                if (selectedWordCard) selectedWordCard.classList.remove('selected');
                selectedWordCard = card;
            } else { // meaning
                if (selectedMeaningCard) selectedMeaningCard.classList.remove('selected');
                selectedMeaningCard = card;
            }
            
            card.classList.add('selected');

            // Ki·ªÉm tra gh√©p ƒë√¥i
            if (selectedWordCard && selectedMeaningCard) {
                const wordKey = selectedWordCard.dataset.match;
                const meaningKey = selectedMeaningCard.dataset.match;

                if (wordKey === meaningKey) {
                    // Gh√©p ƒë√∫ng
                    score++;
                    matchedCount++;
                    
                    selectedWordCard.classList.remove('selected');
                    selectedMeaningCard.classList.remove('selected');

                    selectedWordCard.classList.add('matched');
                    selectedMeaningCard.classList.add('matched');

                    document.getElementById('matching-feedback').textContent = 'Gh√©p ƒë√∫ng! ‚úÖ';
                    document.getElementById('matching-feedback').style.color = 'green';
                    
                    if (matchedCount === currentQuizData.length) {
                        setTimeout(() => {
                             document.getElementById('matching-feedback').textContent = 'Ho√†n th√†nh b√†i t·∫≠p! üéâ';
                             endQuiz(); // K·∫øt th√∫c quiz
                        }, 500);
                    }
                } else {
                    // Gh√©p sai
                    document.getElementById('matching-feedback').textContent = 'Gh√©p sai. Th·ª≠ l·∫°i! ‚ùå';
                    document.getElementById('matching-feedback').style.color = 'red';
                    
                    // B·ªè ch·ªçn sau 500ms
                    setTimeout(() => {
                        selectedWordCard?.classList.remove('selected');
                        selectedMeaningCard?.classList.remove('selected');
                        document.getElementById('matching-feedback').textContent = '';
                    }, 500);
                }

                selectedWordCard = null;
                selectedMeaningCard = null;
            }
        }

        // 4. Logic Nghe & Ch·ªçn (Listening)
        const MAX_LISTENING_ROUNDS = 5;
        let listeningData = [];
        let listeningRound = 0;
        let selectedWord = null;
        let timedOut = false;

        function startListeningGame() {
            listeningRound = 0;
            score = 0;
            document.getElementById('active-quiz-section').classList.add('hidden');
            document.getElementById('listening-game-ui').classList.remove('hidden');
            document.getElementById('total-questions').textContent = MAX_LISTENING_ROUNDS;

            const unitWords = vocabData[currentUnit];
            if (!unitWords || unitWords.length < 5) {
                alert("Kh√¥ng ƒë·ªß t·ª´ v·ª±ng ƒë·ªÉ t·∫°o b√†i nghe (c·∫ßn √≠t nh·∫•t 5 t·ª´).");
                showSection('quiz-section');
                return;
            }

            listeningData = shuffleArray([...unitWords]).slice(0, MAX_LISTENING_ROUNDS);
            nextListeningQuestion();
        }

        function nextListeningQuestion() {
            stopTimer();

            if (listeningRound >= MAX_LISTENING_ROUNDS) {
                endListeningGame();
                return;
            }

            const currentItem = listeningData[listeningRound];
            selectedWord = currentItem.word;
            timedOut = false;
            listeningRound++;

            document.getElementById('current-question-index').textContent = listeningRound;
            document.getElementById('next-question').classList.add('hidden');
            document.getElementById('next-question').onclick = nextListeningQuestion;
            document.getElementById('listening-word').textContent = '';

            const optionsContainer = document.getElementById('listening-options');
            optionsContainer.innerHTML = '';
            
            // X√≥a h·∫øt class correct/incorrect
            Array.from(optionsContainer.children).forEach(card => {
                card.classList.remove('correct', 'incorrect');
                card.onclick = null;
            });


            // T·∫°o 3 ƒë√°p √°n sai (d√πng nghƒ©a ƒë·ªÉ l√†m th·∫ª)
            const allMeanings = vocabData[currentUnit].map(item => item.meaning);
            const wrongMeanings = allMeanings.filter(m => m !== currentItem.meaning);
            const shuffledWrong = shuffleArray(wrongMeanings).slice(0, 3);
            
            // G·ªôp ƒë√°p √°n ƒë√∫ng v√† sai
            const options = shuffleArray([currentItem.meaning, ...shuffledWrong]);

            options.forEach(option => {
                const card = document.createElement('div');
                card.className = 'quiz-card p-4 border rounded-xl text-center shadow-sm hover:shadow-md text-sm md:text-base';
                card.textContent = option;
                card.dataset.word = vocabData[currentUnit].find(item => item.meaning === option)?.word; // L·∫•y t·ª´ ti·∫øng Anh t∆∞∆°ng ·ª©ng
                card.onclick = () => checkListeningAnswer(card, card.dataset.word, selectedWord);
                optionsContainer.appendChild(card);
            });

            // T·ª± ƒë·ªông ph√°t √¢m khi load c√¢u h·ªèi m·ªõi
            speak(selectedWord);

            document.getElementById('listening-play-button').onclick = () => speak(selectedWord);
            startTimerListening();
        }
        
        // C·∫ßn thay ƒë·ªïi logic timer cho Listening v√¨ n√≥ kh√¥ng d√πng chung v·ªõi Writing/MC
        function startTimerListening() {
            clearInterval(timerInterval);
            let timeLeft = TIME_PER_QUESTION;
            const timerBar = document.getElementById('timer-bar');
            timerBar.style.width = '100%';
            timerBar.style.backgroundColor = '#3b82f6';

            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                const percentage = (timeLeft / TIME_PER_QUESTION) * 100;
                timerBar.style.width = percentage + '%';

                if (percentage < 30) {
                    timerBar.style.backgroundColor = '#ef4444';
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timedOut = true;
                    checkListeningAnswer(null, null, selectedWord); // X·ª≠ l√Ω h·∫øt gi·ªù
                }
            }, 100);
        }

        function speak(text) {
             // S·ª≠ d·ª•ng Web Speech API cho ch·ª©c nƒÉng TTS c∆° b·∫£n
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; // ƒê·∫∑t ng√¥n ng·ªØ l√† Ti·∫øng Anh
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API.");
            }
        }


        function checkListeningAnswer(card, clickedWord, correctWord) {
            stopTimer();
            document.getElementById('listening-word').textContent = correctWord; // Hi·ªÉn th·ªã t·ª´ ƒë√∫ng

            const optionsContainer = document.getElementById('listening-options');
            Array.from(optionsContainer.children).forEach(opt => opt.onclick = null); // V√¥ hi·ªáu h√≥a click

            let isCorrect = clickedWord && (clickedWord.toLowerCase() === correctWord.toLowerCase());

            if (isCorrect) {
                if(card) card.classList.add('correct');
                score += 10; // Gi·∫£ s·ª≠ m·ªói c√¢u 10 ƒëi·ªÉm
            } else {
                if(card) card.classList.add('incorrect');
                // Highlight ƒë√°p √°n ƒë√∫ng
                Array.from(optionsContainer.children).forEach(opt => {
                    if (opt.dataset.word && opt.dataset.word.toLowerCase() === correctWord.toLowerCase()) {
                        opt.classList.add('correct');
                    }
                });
            }

            document.getElementById('next-question').classList.remove('hidden');
        }

        function endListeningGame() {
            document.getElementById("listening-game-ui").classList.add("hidden");
            document.getElementById("active-quiz-section").classList.add("hidden");

            // Chuy·ªÉn k·∫øt qu·∫£ sang giao di·ªán chung
            const correctCount = score / 10;
            displayResults(correctCount, MAX_LISTENING_ROUNDS);
            showSection('results-section');
        }

        // 5. Logic Minigame Word Puzzle Tetris

        const wordsTetris = [
            {word:"family", meaning:"Gia ƒë√¨nh"},
            {word:"home", meaning:"Nh√†"},
            {word:"caring", meaning:"Chu ƒë√°o/Quan t√¢m"},
            {word:"share", meaning:"Chia s·∫ª"},
            {word:"clean", meaning:"D·ªçn d·∫πp"},
            {word:"happy", meaning:"H·∫°nh ph√∫c"},
            {word:"support", meaning:"·ª¶ng h·ªô/H·ªó tr·ª£"},
            {word:"work", meaning:"L√†m vi·ªác/C√¥ng vi·ªác"}
        ];

        const cols = 8;
        const rows = 10;
        const cellSize = 50;
        let currentWordTetris = {};
        let fallingLetters = [];
        let grid = [];
        let gameLoopInterval;

        const colors = ["#e3401e","#24a8d1","#e81c8f","#1ed93f","#ed7715","#7628d4","#0fd6af","#ffce03"];

        const gameArea = document.getElementById("gameArea");
        const dropZone = document.getElementById("dropZoneGame");
        const message = document.getElementById("messageGame");
        const resetBtn = document.getElementById("resetBtnGame");
        const info = document.getElementById("info");
        const dropSound = document.getElementById("dropSound");
        const successSound = document.getElementById("successSound");

        function initGridTetris() {
            grid = Array.from({length: rows},()=>Array(cols).fill(null));
            gameArea.innerHTML = "";
            fallingLetters = [];
            clearInterval(gameLoopInterval);
        }

        function startGameTetris(){
            initGridTetris();

            message.textContent="";
            dropZone.innerHTML="";
            resetBtn.style.display = "none";
            info.textContent = "";

            currentWordTetris = wordsTetris[Math.floor(Math.random()*wordsTetris.length)];
            info.textContent = "Nghƒ©a c·∫ßn t√¨m: " + currentWordTetris.meaning;

            // t·∫°o √¥ gh√©p
            for(let i=0;i<currentWordTetris.word.length;i++){
                const slot = document.createElement("div");
                slot.className = "dropSlotGame";
                slot.dataset.index = i;
                dropZone.appendChild(slot);
            }

            // t·∫°o ch·ªØ r∆°i li√™n t·ª•c
            gameLoopInterval = setInterval(()=> {
                const extraLetters = "abcdefghiklmnopqrstuvwxyz".split('').filter(l=>!currentWordTetris.word.includes(l));
                // 70% r∆°i ch·ªØ ƒë√∫ng, 30% r∆°i ch·ªØ sai
                const isCorrect = Math.random() < 0.7; 
                let char;

                if (isCorrect) {
                    const wordChars = currentWordTetris.word.split('');
                    char = wordChars[Math.floor(Math.random()*wordChars.length)];
                } else {
                    char = extraLetters[Math.floor(Math.random()*extraLetters.length)];
                }

                createLetterTetris(char);
            }, 1500); // R∆°i 1.5 gi√¢y/ch·ªØ

            updateTetris();
        }

        function createLetterTetris(char){
            const letter = document.createElement("div");
            const letterId = 'L' + Date.now() + Math.random().toString(16).slice(2);
            letter.className = "letter";
            letter.textContent=char;
            letter.id = letterId;
            const col = Math.floor(Math.random()*(cols));
            letter.style.left = col * cellSize + "px";
            letter.style.top = "0px";
            letter.style.background = colors[Math.floor(Math.random()*colors.length)];
            gameArea.appendChild(letter);

            letter.draggable = true;
            letter.addEventListener("dragstart", dragStartTetris);

            fallingLetters.push({el:letter,row:0,col:col,speed:0.02, id:letterId}); // speed th·∫•p, d√πng update()
        }

        function dragStartTetris(e){
            e.dataTransfer.setData("text/plain", e.target.textContent); // Ch·ªØ
            e.dataTransfer.setData("application/letter-id", e.target.id); // ID ƒë·ªÉ x√≥a sau khi th·∫£

             // T·∫°o h√¨nh ·∫£nh k√©o tu·ª≥ ch·ªânh
            const dragImage = e.target.cloneNode(true);
            dragImage.style.position = 'fixed';
            dragImage.style.top = '-100px';
            document.body.appendChild(dragImage);
            e.dataTransfer.setDragImage(dragImage, 25, 25);
            setTimeout(() => document.body.removeChild(dragImage), 0);
        }

        dropZone.addEventListener("dragover", e=>e.preventDefault());
        dropZone.addEventListener("drop", e=>{
            e.preventDefault();
            const letter = e.dataTransfer.getData("text/plain");
            const id = e.dataTransfer.getData("application/letter-id");
            const target = e.target;
            
            if(target.classList.contains("dropSlotGame") && target.textContent===""){
                target.textContent = letter.toUpperCase(); // In hoa cho ƒë·ªìng nh·∫•t
                target.style.backgroundColor = 'rgb(255, 240, 200)';

                const dragged = document.getElementById(id);
                if(dragged) dragged.remove();
                
                // Lo·∫°i b·ªè kh·ªèi fallingLetters v√† l∆∞·ªõi
                let index = fallingLetters.findIndex(l=>l.id===id);
                if(index !== -1){
                    const letterObj = fallingLetters[index];
                    fallingLetters.splice(index,1);
                    // Clear cell c≈© trong l∆∞·ªõi ƒë·ªÉ tr√°nh ·∫£nh h∆∞·ªüng logic r∆°i
                    if(grid[Math.round(letterObj.row)] && grid[Math.round(letterObj.row)][letterObj.col] === letterObj.el.textContent){
                        grid[Math.round(letterObj.row)][letterObj.col] = null;
                    }
                }
                
                dropSound.play();
                message.textContent = ''; // X√≥a th√¥ng b√°o n·∫øu ƒëang c√≥ l·ªói
            }
        });

        document.getElementById("checkBtn").addEventListener("click",()=>{
            const formedWord=Array.from(dropZone.children).map(slot=>slot.textContent).join('').toLowerCase();
            const correctWord = currentWordTetris.word.toLowerCase();

            if(formedWord===correctWord){
                message.textContent="Ch√≠nh x√°c! T·ª´ t√¨m ƒë∆∞·ª£c l√†: " + currentWordTetris.word.toUpperCase() + " üéâ";
                message.style.color="green";
                successSound.play();
                score += 1; // TƒÉng ƒëi·ªÉm cho minigame
                clearInterval(gameLoopInterval);
                setTimeout(startGameTetris, 3000); // Ch∆°i t·ª´ m·ªõi sau 3s
            }else{
                message.textContent="Sai r·ªìi, th·ª≠ l·∫°i! ‚ùå";
                message.style.color="red";
                resetBtn.style.display="inline-block";
            }
        });

        resetBtn.addEventListener("click",()=>{
            Array.from(dropZone.children).forEach(slot=>{
                slot.textContent="";
                slot.style.backgroundColor = '#ffffff';
            });
            resetBtn.style.display="none";
            message.textContent="";
        });

        function updateTetris(){
            // X√≥a ch·ªØ c√°i ƒë√£ r∆°i kh·ªèi gameArea kh·ªèi fallingLetters
            fallingLetters = fallingLetters.filter(l => gameArea.contains(l.el));

            fallingLetters.forEach(letter=>{
                // Ki·ªÉm tra va ch·∫°m ·ªü √¥ ti·∫øp theo (l√†m tr√≤n l√™n ƒë·ªÉ ki·ªÉm tra √¥ r∆°i)
                let nextRow = Math.floor(letter.row) + 1;
                
                if(nextRow < rows && grid[nextRow][letter.col] === null){
                    // N·∫øu ch∆∞a ch·∫°m ƒë√°y ho·∫∑c kh√¥ng c√≥ v·∫≠t c·∫£n
                    // X√≥a v·ªã tr√≠ c≈© trong l∆∞·ªõi (ch·ªâ khi n√≥ ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u)
                    if(grid[Math.floor(letter.row)][letter.col] === letter.el.textContent) {
                        grid[Math.floor(letter.row)][letter.col] = null;
                    }

                    letter.row += letter.speed * 5; // TƒÉng t·ªëc ƒë·ªô r∆°i

                    // C·∫≠p nh·∫≠t v·ªã tr√≠ m·ªõi trong l∆∞·ªõi khi n√≥ ho√†n to√†n r∆°i v√†o √¥ m·ªõi
                    grid[Math.floor(letter.row)][letter.col] = letter.el.textContent; 

                } else {
                    // ƒê√£ ch·∫°m ƒë√°y ho·∫∑c va ch·∫°m
                    letter.row = Math.floor(letter.row); // ƒê·∫£m b·∫£o v·ªã tr√≠ n·∫±m g·ªçn trong √¥
                    // ƒê√°nh d·∫•u v·ªã tr√≠ cu·ªëi c√πng v√†o l∆∞·ªõi
                    grid[letter.row][letter.col] = letter.el.textContent;
                    
                    // Ki·ªÉm tra Game Over (ch·ªØ r∆°i v√†o h√†ng ƒë·∫ßu ti√™n)
                    if(letter.row <= 0) {
                        clearInterval(gameLoopInterval);
                        message.textContent = "GAME OVER! T·ª´ ƒë√∫ng l√†: " + currentWordTetris.word.toUpperCase();
                        message.style.color = 'red';
                        setTimeout(startGameTetris, 5000); // Kh·ªüi ƒë·ªông l·∫°i sau 5 gi√¢y
                    }
                }
                
                letter.el.style.top = letter.row * cellSize + "px";
                letter.el.style.left = letter.col * cellSize + "px";
            });

            checkLineClearTetris();
            requestAnimationFrame(updateTetris);
        }

        function checkLineClearTetris(){
            let linesCleared = 0;
            for(let r=rows-1;r>=0;r--){
                if(grid[r].every(cell=>cell!==null)){
                    linesCleared++;
                    
                    // X√≥a ch·ªØ c√°i kh·ªèi DOM
                    grid[r].forEach((_,c)=>{
                        const letterEl = Array.from(gameArea.children).find(l=>
                            parseInt(l.style.left) === c*cellSize && 
                            parseInt(l.style.top) === r*cellSize
                        );
                        if(letterEl) letterEl.remove();
                    });

                    // Di chuy·ªÉn c√°c h√†ng tr√™n xu·ªëng
                    for(let rr=r-1; rr>=0; rr--){
                        for(let c=0;c<cols;c++){
                            grid[rr+1][c] = grid[rr][c];
                            if(grid[rr][c]){
                                const letterEl = Array.from(gameArea.children).find(l=>
                                    l.textContent===grid[rr][c] && 
                                    parseInt(l.style.left) === c*cellSize && 
                                    parseInt(l.style.top) === rr*cellSize
                                );
                                if(letterEl) letterEl.style.top = (rr+1)*cellSize + "px";
                            }
                            grid[rr][c] = null;
                        }
                    }
                    r++; // Ki·ªÉm tra l·∫°i h√†ng hi·ªán t·∫°i sau khi di chuy·ªÉn
                }
            }
            if (linesCleared > 0) {
                 dropSound.play(); // D√πng l·∫°i sound drop khi clear
            }
        }

        // --- KH·ªûI T·∫†O ·ª®NG D·ª§NG ---
        window.onload = function() {
            // Thi·∫øt l·∫≠p s·ª± ki·ªán cho c√°c n√∫t tab
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });

            // Thi·∫øt l·∫≠p s·ª± ki·ªán cho n√∫t Unit
            document.querySelectorAll('.unit-button').forEach(button => {
                button.addEventListener('click', function() {
                    selectUnit(this.getAttribute('data-unit'));
                });
            });

            // Thi·∫øt l·∫≠p s·ª± ki·ªán cho n√∫t Quiz Type
            document.querySelectorAll('.quiz-type-button').forEach(button => {
                button.addEventListener('click', function() {
                    const quizType = this.getAttribute('data-quiz');
                    // T·∫Øt minigame loop n·∫øu ƒëang ch·∫°y
                    if (gameLoopInterval) {
                        clearInterval(gameLoopInterval);
                    }
                    if (quizType === 'writing') {
                        document.getElementById('writing-input').onkeyup = function(e) {
                            if (e.key === 'Enter') {
                                // Ki·ªÉm tra xem ƒë√£ c√≥ d·ªØ li·ªáu quiz ch∆∞a ƒë·ªÉ tr√°nh l·ªói
                                if (currentQuizData.length > 0 && currentQuestionIndex > 0) {
                                    checkWritingAnswer(currentQuizData[currentQuestionIndex - 1].word);
                                }
                            }
                        };
                    }
                    startQuiz(quizType);
                });
            });

            // Thi·∫øt l·∫≠p s·ª± ki·ªán cho n√∫t "C√¢u Ti·∫øp Theo"
            document.getElementById('next-question').onclick = nextQuestion;

            // Thi·∫øt l·∫≠p s·ª± ki·ªán cho n√∫t check answer c·ªßa Writing Quiz
            document.getElementById('writing-input').onkeyup = function(e) {
                if (e.key === 'Enter' && !this.disabled && currentQuizData.length > 0 && currentQuestionIndex > 0) {
                    checkWritingAnswer(currentQuizData[currentQuestionIndex - 1].word);
                }
            };


            // Ch·ªçn Unit 1 v√† lo·∫°i quiz Vi·∫øt T·ª´ khi t·∫£i trang
            selectUnit('unit-1');
            startQuiz('writing'); // T·ª± ƒë·ªông kh·ªüi t·∫°o quiz ƒë·∫ßu ti√™n
        };
    </script>
</body>
</html>